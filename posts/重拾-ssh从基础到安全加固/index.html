<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>重拾 SSH：从基础到安全加固 | Aaron Lin</title>
<meta name=keywords content><meta name=description content='安全外壳协议（Secure Shell Protocol，简称SSH）是一种加密的网络传输协议，属于应用层协议。OpenSSH 是最流行的 SSH 实现，它是大量操作系统的默认组件
OpenSSH 套件由以下工具组成：

远程操作使用：ssh, scp 和 sftp
密钥管理：ssh-add, ssh-keysign, ssh-keyscan 和 ssh-keygen
服务端： sshd, sftp-server 和 ssh-agent

使用 SSH 连接服务器
1. 客户端创建公私钥对
密钥类型选择 ed25519 椭圆曲线，它生成的公私钥都要比 RSA 更短，具有较高的安全性和性能
# - a KDF (Key Derivation Function) 的迭代次数 默认：16 ，防止暴力破解
# - t 类型
# Ubuntu 22.04 默认：RSA 3072；Mac OS 默认：ED25519 256

# - C 备注，可以备注上创建年月，定期更换私钥
ssh-keygen -a 256 -t ed25519 -C "Brandon+2025-01@MacBook"
# 可以手动指定路径和密码，也可以一路回车
在 ~/.ssh 下会生成公私钥对
.
├── [ 411]  id_ed25519
├── [  98]  id_ed25519.pub

# 私钥需要妥善保管，避免暴露
cat id_ed25519

-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACCRtC9cJJBFwvVsp4vV058ci8lSHNrf2qcx8W+umtK7OwAAAKArJx9PKycf...
-----END OPENSSH PRIVATE KEY-----

# .pub 结尾为公钥
cat id_ed25519.pub

ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJG0L1wkkEXC9Wyni9XTnxyLIt/zHxb66a0rs7 Brandon+2025-01@MacBook
2. 在服务器上添加公钥
将上面客户端生成的公钥 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJG0L1wkkEXC9Wyni9XTnxyLIt/zHxb66a0rs7 Brandon+2025-01@MacBook
加入到服务端 ~/.ssh/authorized_keys，每个私钥占据一行'><meta name=author content><link rel=canonical href=https://aaronlinv.github.io/posts/%E9%87%8D%E6%8B%BE-ssh%E4%BB%8E%E5%9F%BA%E7%A1%80%E5%88%B0%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.45e028aa8ce0961349adf411b013ee39406be2c0bc80d4ea3fc04555f7f4611a.css integrity="sha256-ReAoqozglhNJrfQRsBPuOUBr4sC8gNTqP8BFVff0YRo=" rel="preload stylesheet" as=style><link rel=icon href=https://aaronlinv.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://aaronlinv.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://aaronlinv.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://aaronlinv.github.io/apple-touch-icon.png><link rel=mask-icon href=https://aaronlinv.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://aaronlinv.github.io/posts/%E9%87%8D%E6%8B%BE-ssh%E4%BB%8E%E5%9F%BA%E7%A1%80%E5%88%B0%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://aaronlinv.github.io/posts/%E9%87%8D%E6%8B%BE-ssh%E4%BB%8E%E5%9F%BA%E7%A1%80%E5%88%B0%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/"><meta property="og:site_name" content="Aaron Lin"><meta property="og:title" content="重拾 SSH：从基础到安全加固"><meta property="og:description" content='安全外壳协议（Secure Shell Protocol，简称SSH）是一种加密的网络传输协议，属于应用层协议。OpenSSH 是最流行的 SSH 实现，它是大量操作系统的默认组件
OpenSSH 套件由以下工具组成：
远程操作使用：ssh, scp 和 sftp 密钥管理：ssh-add, ssh-keysign, ssh-keyscan 和 ssh-keygen 服务端： sshd, sftp-server 和 ssh-agent 使用 SSH 连接服务器 1. 客户端创建公私钥对 密钥类型选择 ed25519 椭圆曲线，它生成的公私钥都要比 RSA 更短，具有较高的安全性和性能
# - a KDF (Key Derivation Function) 的迭代次数 默认：16 ，防止暴力破解 # - t 类型 # Ubuntu 22.04 默认：RSA 3072；Mac OS 默认：ED25519 256 # - C 备注，可以备注上创建年月，定期更换私钥 ssh-keygen -a 256 -t ed25519 -C "Brandon+2025-01@MacBook" # 可以手动指定路径和密码，也可以一路回车 在 ~/.ssh 下会生成公私钥对
. ├── [ 411] id_ed25519 ├── [ 98] id_ed25519.pub # 私钥需要妥善保管，避免暴露 cat id_ed25519 -----BEGIN OPENSSH PRIVATE KEY----- b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW QyNTUxOQAAACCRtC9cJJBFwvVsp4vV058ci8lSHNrf2qcx8W+umtK7OwAAAKArJx9PKycf... -----END OPENSSH PRIVATE KEY----- # .pub 结尾为公钥 cat id_ed25519.pub ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJG0L1wkkEXC9Wyni9XTnxyLIt/zHxb66a0rs7 Brandon+2025-01@MacBook 2. 在服务器上添加公钥 将上面客户端生成的公钥 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJG0L1wkkEXC9Wyni9XTnxyLIt/zHxb66a0rs7 Brandon+2025-01@MacBook 加入到服务端 ~/.ssh/authorized_keys，每个私钥占据一行'><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-01-24T08:46:33+08:00"><meta property="article:modified_time" content="2025-01-24T08:46:33+08:00"><meta property="og:image" content="https://aaronlinv.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://aaronlinv.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="重拾 SSH：从基础到安全加固"><meta name=twitter:description content='安全外壳协议（Secure Shell Protocol，简称SSH）是一种加密的网络传输协议，属于应用层协议。OpenSSH 是最流行的 SSH 实现，它是大量操作系统的默认组件
OpenSSH 套件由以下工具组成：

远程操作使用：ssh, scp 和 sftp
密钥管理：ssh-add, ssh-keysign, ssh-keyscan 和 ssh-keygen
服务端： sshd, sftp-server 和 ssh-agent

使用 SSH 连接服务器
1. 客户端创建公私钥对
密钥类型选择 ed25519 椭圆曲线，它生成的公私钥都要比 RSA 更短，具有较高的安全性和性能
# - a KDF (Key Derivation Function) 的迭代次数 默认：16 ，防止暴力破解
# - t 类型
# Ubuntu 22.04 默认：RSA 3072；Mac OS 默认：ED25519 256

# - C 备注，可以备注上创建年月，定期更换私钥
ssh-keygen -a 256 -t ed25519 -C "Brandon+2025-01@MacBook"
# 可以手动指定路径和密码，也可以一路回车
在 ~/.ssh 下会生成公私钥对
.
├── [ 411]  id_ed25519
├── [  98]  id_ed25519.pub

# 私钥需要妥善保管，避免暴露
cat id_ed25519

-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACCRtC9cJJBFwvVsp4vV058ci8lSHNrf2qcx8W+umtK7OwAAAKArJx9PKycf...
-----END OPENSSH PRIVATE KEY-----

# .pub 结尾为公钥
cat id_ed25519.pub

ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJG0L1wkkEXC9Wyni9XTnxyLIt/zHxb66a0rs7 Brandon+2025-01@MacBook
2. 在服务器上添加公钥
将上面客户端生成的公钥 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJG0L1wkkEXC9Wyni9XTnxyLIt/zHxb66a0rs7 Brandon+2025-01@MacBook
加入到服务端 ~/.ssh/authorized_keys，每个私钥占据一行'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://aaronlinv.github.io/posts/"},{"@type":"ListItem","position":2,"name":"重拾 SSH：从基础到安全加固","item":"https://aaronlinv.github.io/posts/%E9%87%8D%E6%8B%BE-ssh%E4%BB%8E%E5%9F%BA%E7%A1%80%E5%88%B0%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"重拾 SSH：从基础到安全加固","name":"重拾 SSH：从基础到安全加固","description":"安全外壳协议（Secure Shell Protocol，简称SSH）是一种加密的网络传输协议，属于应用层协议。OpenSSH 是最流行的 SSH 实现，它是大量操作系统的默认组件\nOpenSSH 套件由以下工具组成：\n远程操作使用：ssh, scp 和 sftp 密钥管理：ssh-add, ssh-keysign, ssh-keyscan 和 ssh-keygen 服务端： sshd, sftp-server 和 ssh-agent 使用 SSH 连接服务器 1. 客户端创建公私钥对 密钥类型选择 ed25519 椭圆曲线，它生成的公私钥都要比 RSA 更短，具有较高的安全性和性能\n# - a KDF (Key Derivation Function) 的迭代次数 默认：16 ，防止暴力破解 # - t 类型 # Ubuntu 22.04 默认：RSA 3072；Mac OS 默认：ED25519 256 # - C 备注，可以备注上创建年月，定期更换私钥 ssh-keygen -a 256 -t ed25519 -C \u0026#34;Brandon+2025-01@MacBook\u0026#34; # 可以手动指定路径和密码，也可以一路回车 在 ~/.ssh 下会生成公私钥对\n. ├── [ 411] id_ed25519 ├── [ 98] id_ed25519.pub # 私钥需要妥善保管，避免暴露 cat id_ed25519 -----BEGIN OPENSSH PRIVATE KEY----- b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW QyNTUxOQAAACCRtC9cJJBFwvVsp4vV058ci8lSHNrf2qcx8W+umtK7OwAAAKArJx9PKycf... -----END OPENSSH PRIVATE KEY----- # .pub 结尾为公钥 cat id_ed25519.pub ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJG0L1wkkEXC9Wyni9XTnxyLIt/zHxb66a0rs7 Brandon+2025-01@MacBook 2. 在服务器上添加公钥 将上面客户端生成的公钥 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJG0L1wkkEXC9Wyni9XTnxyLIt/zHxb66a0rs7 Brandon+2025-01@MacBook 加入到服务端 ~/.ssh/authorized_keys，每个私钥占据一行\n","keywords":[],"articleBody":"安全外壳协议（Secure Shell Protocol，简称SSH）是一种加密的网络传输协议，属于应用层协议。OpenSSH 是最流行的 SSH 实现，它是大量操作系统的默认组件\nOpenSSH 套件由以下工具组成：\n远程操作使用：ssh, scp 和 sftp 密钥管理：ssh-add, ssh-keysign, ssh-keyscan 和 ssh-keygen 服务端： sshd, sftp-server 和 ssh-agent 使用 SSH 连接服务器 1. 客户端创建公私钥对 密钥类型选择 ed25519 椭圆曲线，它生成的公私钥都要比 RSA 更短，具有较高的安全性和性能\n# - a KDF (Key Derivation Function) 的迭代次数 默认：16 ，防止暴力破解 # - t 类型 # Ubuntu 22.04 默认：RSA 3072；Mac OS 默认：ED25519 256 # - C 备注，可以备注上创建年月，定期更换私钥 ssh-keygen -a 256 -t ed25519 -C \"Brandon+2025-01@MacBook\" # 可以手动指定路径和密码，也可以一路回车 在 ~/.ssh 下会生成公私钥对\n. ├── [ 411] id_ed25519 ├── [ 98] id_ed25519.pub # 私钥需要妥善保管，避免暴露 cat id_ed25519 -----BEGIN OPENSSH PRIVATE KEY----- b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW QyNTUxOQAAACCRtC9cJJBFwvVsp4vV058ci8lSHNrf2qcx8W+umtK7OwAAAKArJx9PKycf... -----END OPENSSH PRIVATE KEY----- # .pub 结尾为公钥 cat id_ed25519.pub ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJG0L1wkkEXC9Wyni9XTnxyLIt/zHxb66a0rs7 Brandon+2025-01@MacBook 2. 在服务器上添加公钥 将上面客户端生成的公钥 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJG0L1wkkEXC9Wyni9XTnxyLIt/zHxb66a0rs7 Brandon+2025-01@MacBook 加入到服务端 ~/.ssh/authorized_keys，每个私钥占据一行\n也可以使用 `ssh-copy-id\nssh-copy-id -i ~/.ssh/id_ed25519.pub ubuntu@192.168.64.6 3. 客户端 ssh 连接 # 登录的用户名@目标主机的 IP 地址 ssh root@192.168.16.13 # 首次连接某个服务器会提示 The authenticity of host '192.168.16.13 (192.168.16.13)' can't be established. ED25519 key fingerprint is SHA256:QawKK4qYtzv/WyymFO64Yby5oxo9bVYZu0TQRvLZsL8. This key is not known by any other names. Are you sure you want to continue connecting (yes/no/[fingerprint])? 这是需要要求你通过 服务端公钥指纹 来验证服务端的身份，避免中间人攻击。在确认指纹后输入 yes 完成连接，ssh 会将公钥信息写入到 ~/.ssh/known_hosts 中。后续连接如果服务端指纹变更，就说明可能出现了中间人攻击，ssh 会在连接时提示指纹不一致\n获取服务端公钥指纹 在 服务端 /etc/ssh/ 下有多对公私钥：\n├── [1.3K] ssh_host_dsa_key ├── [ 609] ssh_host_dsa_key.pub ├── [ 513] ssh_host_ecdsa_key ├── [ 181] ssh_host_ecdsa_key.pub ├── [ 411] ssh_host_ed25519_key ├── [ 101] ssh_host_ed25519_key.pub ├── [2.5K] ssh_host_rsa_key ├── [ 573] ssh_host_rsa_key.pub 以 ed25519 为例，查看公钥指纹：\n# -l：列出密钥的指纹 # -f：后面跟要查看的文件路径 ssh-keygen -lf /etc/ssh/ssh_host_ed25519_key.pub 256 SHA256:WykOLKFPEwaC42OM8B5EgFBS5RlgV4qvXxkCIxPE6h4 root@VM-12-5-ubuntu (ED25519) 如果无法登陆服务器，可以直接获取，相对来说还是找管理员索要指纹更加安全\nssh-keyscan -t ed25519 -p 22 192.168.16.13 2\u003e/dev/null | ssh-keygen -E sha256 -lf - 256 SHA256:WykOLKFPEwaC42OM8B5EgFBS5RlgV4qvXxkCIxPE6h4 root@VM-12-5-ubuntu (ED25519) 关于 ssh 还有一个常见用法，就是测试 GitHub 连通性\n# 测试 GitHub 连接 # -T: 禁用伪终端分配 ssh -T git@github.com # 回应： # Hi someone! You've successfully authenticated, but GitHub does not provide shell access. 连接过程 加密连接最重要的就是解决 密钥传递 的问题，如果传递密钥时密钥被窃取，那么后续的加密将毫无意义\n为了避免传递时泄露密钥，ssh 采用了 非对称加密算法，即公私钥的这种方式。服务器和客户端在 确认对方的公钥是安全的 之后，就可以通过对方的公钥加密数据，对方通过私钥解密数据，实现安全地传输数据。客户端与服务器连接的具体过程：\n建立 TCP 连接 协商 SSH 版本：SSH1 或 SSH2 协商使用的 算法：加密、密钥交换、消息认证码等 用协商好的密钥交换算法（例如 Elliptic Curve Diffie-Hellman）生成共享密钥，通过它进行回话的对称加密5 客户端验证服务器身份: 为了防止中间人攻击，比较服务器的公钥指纹或密钥与客户端已知的主机是否一致, 不一致或者首次连接会提示用户验证服务器的公钥指纹 服务器验证用户身份: 服务器验证客户端的身份 会话建立: 身份验证成功后，客户端和服务器之间建立加密的会话 Elliptic Curve Diffie-Hellman： 双方分别生成一对临时 公私钥对，将自己的 临时公钥 发送给对方，双方都可以通过 对方临时公钥 + 自己临时私钥 生成 共享密钥，这个共享密钥双方相同。共享密钥 作为 KDF 的输入，生成多个密钥，用于加密、完整性校验\n交换哈希 (Exchange Hash)：为了确保密钥交换过程没有被篡改，SSH 会计算一个交换哈希值，服务器会对交换哈希进行签名（这里用的是服务器私钥，即 /etc/ssh/ 下的私钥）。哈希值包含了密钥交换过程中交换的所有数据，包括客户端和服务器版本、算法协商结果、密钥交换参数等\nssh 连接过程的数据包：\n从流程可以看出，ssh 虽然可以保证会话传输安全，但是无法保证对方身份的真实性，所以在连接时要 确认公钥指纹\n常见问题 回话保持 删除 authorized_keys 中的 key，该 key 已打开的会话不会被断开\n可以通过 pkill 终止特定用户的 SSH 会话：\npkill -u $username sshd 权限导致登陆失败 在 man ssh 中：\n~/.ssh/: the recommended permissions are read/write/execute for the user, and not accessible by others. ~/.ssh/authorized_keys: the recommended permissions are read/write for the user, and not accessible by others.\n保证 ~/.ssh authorized_keys 只有 所有者 可以访问修改\n如果我们修改权限：chmod 666 authorized_keys，这样登陆会失败：\nshell failed: ssh failed to authenticate: 'Access denied for 'publickey'. Authentication that can continue: publickey' 在 sshd 的日志中也可以看到原因：\ntail -f /var/log/auth.log 2025-01-17T11:36:41.734631+08:00 iptables sshd[1294]: Authentication refused: bad ownership or modes for file /home/ubuntu/.ssh/authorized_keys .ssh 子目录中的 config 通过 config 简化 ssh 连接\nHost aliyun HostName 192.168.1.100 User tom IdentityFile ~/.ssh/id_rsa Port 22 # ssh $Host 快速连接 ssh aliyun 安全防护 查看连接 # who 查看当前登录用户的方法。它会显示用户名、终端、登录时间以及远程主机（如果是 SSH 连接） who ubuntu pts/0 2025-01-20 17:43 (192.168.64.1) # w 命令提供更详细的信息，包括当前登录用户、他们正在运行的进程、系统负载等。 w 19:44:32 up 14:48, 2 users, load average: 0.06, 0.04, 0.00 USER TTY FROM LOGIN@ IDLE JCPU PCPU WHAT ubuntu 192.168.64.1 17:43 3days 0.00s 0.05s sshd: ubuntu [priv] ubuntu 192.168.64.1 17:43 3days 0.00s ? sshd: ubuntu [priv] # last 命令显示最近登录的用户列表，包括用户名、终端、登录时间、远程主机和登出时间 last ubuntu pts/0 192.168.64.1 Mon Jan 20 17:43 still logged in ubuntu pts/0 192.168.64.1 Fri Jan 17 11:33 - 11:47 (00:13) reboot system boot 6.8.0-51-generic Fri Jan 17 11:33 still running reboot system boot 6.8.0-51-generic Thu Jan 9 16:58 - 17:11 (00:13) ubuntu pts/0 192.168.64.1 Thu Jan 9 16:57 - 16:58 (00:00) # lastlog 命令显示每个用户最后一次登录的时间 lastlog Username Port From Latest root **Never logged in** daemon **Never logged in** bin **Never logged in** sys **Never logged in** ubuntu pts/0 192.168.64.1 Mon Jan 20 17:43:58 +0800 2025 安全策略 pkill 会话 ps ajfx PPID PID PGID SID TTY TPGID STAT UID TIME COMMAND 1 1621867 1621867 1621867 ? -1 Ss 0 0:49 sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 sta 1621867 2226258 2226258 2226258 ? -1 Ss 0 0:00 \\_ sshd: root@pts/5 2226258 2226414 2226414 2226414 pts/5 2227480 Ss 0 0:00 \\_ bash --rcfile /dev/fd/63 2226414 2227480 2227480 2226414 pts/5 2227480 R+ 0 0:00 \\_ ps ajfx 通过 SID 可以 kill 掉整个 session，如果 pikill tmux 等软件创建的 session，这些 session 的进程还是会继续运行\n# -e: 显示进程将被终止 # -s: 指定一个或多个会话 ID # pkill -e -s $SID pkill -e -s 2226258 排查用户和密钥 查看非 root 可登录的账号\nawk -F: 'BEGIN {OFS=\":\"} $3 != 0 \u0026\u0026 $7 !~ /\\/bin\\/false|\\/nologin/ {print $1}' /etc/passwd 查看允许 ssh 登陆的公钥：\ncat ~/.ssh/authorized_keys\n禁用密码登陆 grep PasswordAuthentication /etc/ssh/sshd_config 注意：这里是 sshd_config，而不是少了 d 的 ssh_config\n如果 /etc/ssh/sshd_config.d 中的某个文件中定义了某个配置选项，那么它会覆盖 /etc/ssh/sshd_config 文件中相同的配置\n例如在 /etc/ssh/sshd_config.d/50-cloud-init.conf 中配置了 PasswordAuthentication yes，那么 /etc/ssh/sshd_config 中修改 PasswordAuthentication 的值都会被覆盖，即密码登陆一直有效，修改为 PasswordAuthentication no 后重新 sshd：sudo systemctl restart sshd，就会提示只允许密钥登陆：\nssh root@192.168.64.6 root@192.168.64.6: Permission denied (publickey). 如果没有关闭密码登陆，就可能会被暴力破解，查询不同用户被尝试登陆的次数：\ngrep \"Failed password\" /var/log/auth.log|perl -e 'while($_=\u003c\u003e){ /for(.*?)from/; print \"$1\\n\";}'|sort|uniq -c|sort -nr 5611 root 2013 invalid user hadoop 1975 invalid user inspur 1973 invalid user cloud 285 invalid user roo 101 invalid user test 84 invalid user user 72 invalid user admin 68 invalid user oracle 61 invalid user postgres 61 invalid user git 48 invalid user ubuntu 31 invalid user test1 28 invalid user amandabackup 24 invalid user pcpqa 22 invalid user ftpuser 21 invalid user test2 21 invalid user chenly 查询登陆成功的 IP\ngrep \"Accepted\" /var/log/auth.log | awk '{print $11}' | sort | uniq 其他安全配置可以参考：\nLinux 应急响应手册 v1.9 - NOP Team 如何配置安全的 SSH 服务 SSH安全加固指南\n登陆告警 在用户登陆时向钉钉发送告警，参考自：VPS 安全加固之用户登录后向 telegram 发送登录信息\ncd /etc/profile.d/ vim ssh-login-alerm.sh #!/bin/bash # 钉钉机器人 Webhook URL dingtalk_webhook=\"https://oapi.dingtalk.com/robot/send?access_token=$token\" # 获取系统信息，并进行转义以避免 JSON 解析错误 message=$(hostname \u0026\u0026 TZ=UTC-8 date '+%Y-%m-%d %H:%M:%S' \u0026\u0026 who \u0026\u0026 w | awk 'BEGIN{OFS=\"\\t\"}{print $1,$8}' | sed 's/\\\\/\\\\\\\\/g;s/\\n/\\\\n/g;s/\"/\\\\\"/g') # 使用 curl 发送消息到钉钉机器人 curl -s -X POST \\ -H \"Content-Type: application/json\" \\ -d \"{\\\"msgtype\\\":\\\"text\\\",\\\"text\\\":{\\\"content\\\":\\\"ssh: ${message}\\\"}}\" \\ \"${dingtalk_webhook}\" || echo \"Error sending DingTalk message.\" #可选：添加日志记录 echo \"$(date '+%Y-%m-%d %H:%M:%S') - SSH login detected. Message sent to DingTalk (or error occurred).\" \u003e\u003e /var/log/ssh_login_dingtalk.log # 权限设置为 555 ，这样登陆任何用户都会执行告警 chmod 555 /etc/profile.d/ssh-login-alerm.sh 登陆后钉钉会收到一条消息:\nssh: localhost 2025-01-23 22:17:16 root pts/0 2025-01-23 22:17 (192.168.64.5) 22:17:16\tload USER\tWHAT root\tbash 参考资料 Secure Shell - wiki OpenSSH - wiki SSH-Keygen的更安全用法 It’s 2023. You Should Be Using an Ed25519 SSH Key (And Other Current Best Practices) 验证远程主机SSH指纹 什么是SSH？ 图解SSH原理 SSH协议解析及wireshark抓包分析 SSH协议握手核心过程\n","wordCount":"970","inLanguage":"en","image":"https://aaronlinv.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2025-01-24T08:46:33+08:00","dateModified":"2025-01-24T08:46:33+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://aaronlinv.github.io/posts/%E9%87%8D%E6%8B%BE-ssh%E4%BB%8E%E5%9F%BA%E7%A1%80%E5%88%B0%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/"},"publisher":{"@type":"Organization","name":"Aaron Lin","logo":{"@type":"ImageObject","url":"https://aaronlinv.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://aaronlinv.github.io/ accesskey=h title="Aaron's Blog (Alt + H)">Aaron's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://aaronlinv.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://aaronlinv.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://aaronlinv.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://aaronlinv.github.io/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">重拾 SSH：从基础到安全加固</h1><div class=post-meta><span title='2025-01-24 08:46:33 +0800 +0800'>January 24, 2025</span></div></header><div class=post-content><p>安全外壳协议（Secure Shell Protocol，简称SSH）是一种加密的网络传输协议，属于应用层协议。<a href=https://www.openssh.com/>OpenSSH</a> 是最流行的 SSH 实现，它是大量操作系统的默认组件</p><p>OpenSSH 套件由以下工具组成：</p><ul><li>远程操作使用：<strong>ssh</strong>, <strong>scp</strong> 和 sftp</li><li>密钥管理：ssh-add, ssh-keysign, ssh-keyscan 和 <strong>ssh-keygen</strong></li><li>服务端： <strong>sshd</strong>, sftp-server 和 ssh-agent</li></ul><h2 id=使用-ssh-连接服务器>使用 SSH 连接服务器<a hidden class=anchor aria-hidden=true href=#使用-ssh-连接服务器>#</a></h2><h3 id=1-客户端创建公私钥对>1. 客户端创建公私钥对<a hidden class=anchor aria-hidden=true href=#1-客户端创建公私钥对>#</a></h3><p>密钥类型选择 <code>ed25519</code> 椭圆曲线，它生成的公私钥都要比 <code>RSA</code> 更短，具有较高的安全性和性能</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># - a KDF (Key Derivation Function) 的迭代次数 默认：16 ，防止暴力破解</span>
</span></span><span class=line><span class=cl><span class=c1># - t 类型</span>
</span></span><span class=line><span class=cl><span class=c1># Ubuntu 22.04 默认：RSA 3072；Mac OS 默认：ED25519 256</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># - C 备注，可以备注上创建年月，定期更换私钥</span>
</span></span><span class=line><span class=cl>ssh-keygen -a <span class=m>256</span> -t ed25519 -C <span class=s2>&#34;Brandon+2025-01@MacBook&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 可以手动指定路径和密码，也可以一路回车</span>
</span></span></code></pre></div><p>在 <code>~/.ssh</code> 下会生成公私钥对</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── <span class=o>[</span> 411<span class=o>]</span>  id_ed25519
</span></span><span class=line><span class=cl>├── <span class=o>[</span>  98<span class=o>]</span>  id_ed25519.pub
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 私钥需要妥善保管，避免暴露</span>
</span></span><span class=line><span class=cl>cat id_ed25519
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-----BEGIN OPENSSH PRIVATE KEY-----
</span></span><span class=line><span class=cl>b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
</span></span><span class=line><span class=cl>QyNTUxOQAAACCRtC9cJJBFwvVsp4vV058ci8lSHNrf2qcx8W+umtK7OwAAAKArJx9PKycf...
</span></span><span class=line><span class=cl>-----END OPENSSH PRIVATE KEY-----
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># .pub 结尾为公钥</span>
</span></span><span class=line><span class=cl>cat id_ed25519.pub
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJG0L1wkkEXC9Wyni9XTnxyLIt/zHxb66a0rs7 Brandon+2025-01@MacBook
</span></span></code></pre></div><h3 id=2-在服务器上添加公钥>2. 在服务器上添加公钥<a hidden class=anchor aria-hidden=true href=#2-在服务器上添加公钥>#</a></h3><p>将上面客户端生成的公钥 <code>ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJG0L1wkkEXC9Wyni9XTnxyLIt/zHxb66a0rs7 Brandon+2025-01@MacBook</code>
加入到服务端 <code>~/.ssh/authorized_keys</code>，每个私钥占据一行</p><p>也可以使用 `ssh-copy-id</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ssh-copy-id -i ~/.ssh/id_ed25519.pub ubuntu@192.168.64.6
</span></span></code></pre></div><h3 id=3-客户端-ssh-连接>3. 客户端 ssh 连接<a hidden class=anchor aria-hidden=true href=#3-客户端-ssh-连接>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 登录的用户名@目标主机的 IP 地址</span>
</span></span><span class=line><span class=cl>ssh root@192.168.16.13
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 首次连接某个服务器会提示</span>
</span></span><span class=line><span class=cl>The authenticity of host <span class=s1>&#39;192.168.16.13 (192.168.16.13)&#39;</span> can<span class=err>&#39;</span>t be established.
</span></span><span class=line><span class=cl>ED25519 key fingerprint is SHA256:QawKK4qYtzv/WyymFO64Yby5oxo9bVYZu0TQRvLZsL8.
</span></span><span class=line><span class=cl>This key is not known by any other names.
</span></span><span class=line><span class=cl>Are you sure you want to <span class=k>continue</span> connecting <span class=o>(</span>yes/no/<span class=o>[</span>fingerprint<span class=o>])</span>?
</span></span></code></pre></div><p>这是需要要求你通过 <strong>服务端公钥指纹</strong> 来验证服务端的身份，避免中间人攻击。在确认指纹后输入 <code>yes</code> 完成连接，ssh 会将公钥信息写入到 <code>~/.ssh/known_hosts</code> 中。后续连接如果服务端指纹变更，就说明可能出现了中间人攻击，ssh 会在连接时提示指纹不一致</p><h4 id=获取服务端公钥指纹>获取服务端公钥指纹<a hidden class=anchor aria-hidden=true href=#获取服务端公钥指纹>#</a></h4><p>在 <strong>服务端</strong> <code>/etc/ssh/</code> 下有多对公私钥：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>├── <span class=o>[</span>1.3K<span class=o>]</span>  ssh_host_dsa_key
</span></span><span class=line><span class=cl>├── <span class=o>[</span> 609<span class=o>]</span>  ssh_host_dsa_key.pub
</span></span><span class=line><span class=cl>├── <span class=o>[</span> 513<span class=o>]</span>  ssh_host_ecdsa_key
</span></span><span class=line><span class=cl>├── <span class=o>[</span> 181<span class=o>]</span>  ssh_host_ecdsa_key.pub
</span></span><span class=line><span class=cl>├── <span class=o>[</span> 411<span class=o>]</span>  ssh_host_ed25519_key
</span></span><span class=line><span class=cl>├── <span class=o>[</span> 101<span class=o>]</span>  ssh_host_ed25519_key.pub
</span></span><span class=line><span class=cl>├── <span class=o>[</span>2.5K<span class=o>]</span>  ssh_host_rsa_key
</span></span><span class=line><span class=cl>├── <span class=o>[</span> 573<span class=o>]</span>  ssh_host_rsa_key.pub
</span></span></code></pre></div><p>以 <code>ed25519</code> 为例，查看公钥指纹：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># -l：列出密钥的指纹</span>
</span></span><span class=line><span class=cl><span class=c1># -f：后面跟要查看的文件路径</span>
</span></span><span class=line><span class=cl>ssh-keygen -lf /etc/ssh/ssh_host_ed25519_key.pub
</span></span><span class=line><span class=cl><span class=m>256</span> SHA256:WykOLKFPEwaC42OM8B5EgFBS5RlgV4qvXxkCIxPE6h4 root@VM-12-5-ubuntu <span class=o>(</span>ED25519<span class=o>)</span>
</span></span></code></pre></div><p>如果无法登陆服务器，可以直接获取，相对来说还是找管理员索要指纹更加安全</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ssh-keyscan -t ed25519 -p <span class=m>22</span> 192.168.16.13 2&gt;/dev/null <span class=p>|</span> ssh-keygen -E sha256 -lf -
</span></span><span class=line><span class=cl><span class=m>256</span> SHA256:WykOLKFPEwaC42OM8B5EgFBS5RlgV4qvXxkCIxPE6h4 root@VM-12-5-ubuntu <span class=o>(</span>ED25519<span class=o>)</span>
</span></span></code></pre></div><p>关于 ssh 还有一个常见用法，就是测试 GitHub 连通性</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 测试 GitHub 连接</span>
</span></span><span class=line><span class=cl><span class=c1># -T: 禁用伪终端分配</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ssh -T git@github.com
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 回应：</span>
</span></span><span class=line><span class=cl><span class=c1># Hi someone! You&#39;ve successfully authenticated, but GitHub does not provide shell access.</span>
</span></span></code></pre></div><h2 id=连接过程>连接过程<a hidden class=anchor aria-hidden=true href=#连接过程>#</a></h2><p>加密连接最重要的就是解决 <strong>密钥传递</strong> 的问题，如果传递密钥时密钥被窃取，那么后续的加密将毫无意义</p><p>为了避免传递时泄露密钥，ssh 采用了 <strong>非对称加密算法</strong>，即公私钥的这种方式。服务器和客户端在 <strong>确认对方的公钥是安全的</strong> 之后，就可以通过对方的公钥加密数据，对方通过私钥解密数据，实现安全地传输数据。客户端与服务器连接的具体过程：</p><ol><li>建立 TCP 连接</li><li>协商 <strong>SSH 版本</strong>：SSH1 或 SSH2</li><li>协商使用的 <strong>算法</strong>：加密、密钥交换、消息认证码等</li><li>用协商好的密钥交换算法（例如 Elliptic Curve Diffie-Hellman）<strong>生成共享密钥</strong>，通过它进行回话的对称加密5</li><li>客户端验证服务器身份: 为了防止中间人攻击，比较服务器的公钥指纹或密钥与客户端已知的主机是否一致, 不一致或者首次连接会提示用户验证服务器的公钥指纹</li><li>服务器验证用户身份: 服务器验证客户端的身份</li><li>会话建立: 身份验证成功后，客户端和服务器之间建立加密的会话</li></ol><p><a href=https://zh.wikipedia.org/wiki/%E6%A9%A2%E5%9C%93%E6%9B%B2%E7%B7%9A%E8%BF%AA%E8%8F%B2-%E8%B5%AB%E7%88%BE%E6%9B%BC%E9%87%91%E9%91%B0%E4%BA%A4%E6%8F%9B>Elliptic Curve Diffie-Hellman</a>：
双方分别生成一对临时 <strong>公私钥对</strong>，将自己的 <strong>临时公钥</strong> 发送给对方，双方都可以通过 对方临时公钥 + 自己临时私钥 生成 <strong>共享密钥</strong>，这个共享密钥双方相同。<strong>共享密钥</strong> 作为 KDF 的输入，生成多个密钥，用于加密、完整性校验</p><p>交换哈希 (Exchange Hash)：为了确保密钥交换过程没有被篡改，SSH 会计算一个交换哈希值，服务器会对交换哈希进行签名（这里用的是服务器私钥，即 <code>/etc/ssh/</code> 下的私钥）。哈希值包含了密钥交换过程中交换的所有数据，包括客户端和服务器版本、算法协商结果、密钥交换参数等</p><p>ssh 连接过程的数据包：</p><p><img loading=lazy src=../%E9%87%8D%E6%8B%BESSH%EF%BC%9A%E4%BB%8E%E5%9F%BA%E7%A1%80%E5%88%B0%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/1929786-20250123170050410-1584713012.png></p><p>从流程可以看出，ssh 虽然可以保证会话传输安全，但是无法保证对方身份的真实性，所以在连接时要 <strong>确认公钥指纹</strong></p><h2 id=常见问题>常见问题<a hidden class=anchor aria-hidden=true href=#常见问题>#</a></h2><h3 id=回话保持>回话保持<a hidden class=anchor aria-hidden=true href=#回话保持>#</a></h3><p>删除 <code>authorized_keys</code> 中的 key，该 key 已打开的会话不会被断开</p><p>可以通过 pkill 终止特定用户的 SSH 会话：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>pkill -u <span class=nv>$username</span> sshd
</span></span></code></pre></div><h3 id=权限导致登陆失败>权限导致登陆失败<a hidden class=anchor aria-hidden=true href=#权限导致登陆失败>#</a></h3><p>在 <code>man ssh</code> 中：</p><blockquote><p>~/.ssh/: the recommended permissions are read/write/execute for the user, and not accessible by others.
~/.ssh/authorized_keys: the recommended permissions are read/write for the user, and not accessible by others.</p></blockquote><p>保证 <code>~/.ssh</code> <code>authorized_keys</code> 只有 <strong>所有者</strong> 可以访问修改</p><p>如果我们修改权限：<code>chmod 666 authorized_keys</code>，这样登陆会失败：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>shell failed: ssh failed to authenticate: <span class=s1>&#39;Access denied for &#39;</span>publickey<span class=s1>&#39;. Authentication that can continue: publickey&#39;</span>
</span></span></code></pre></div><p>在 sshd 的日志中也可以看到原因：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>tail -f /var/log/auth.log
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>2025-01-17T11:36:41.734631+08:00 iptables sshd<span class=o>[</span>1294<span class=o>]</span>: Authentication refused: bad ownership or modes <span class=k>for</span> file /home/ubuntu/.ssh/authorized_keys
</span></span></code></pre></div><h3 id=ssh-子目录中的-config>.ssh 子目录中的 config<a hidden class=anchor aria-hidden=true href=#ssh-子目录中的-config>#</a></h3><p>通过 config 简化 ssh 连接</p><pre tabindex=0><code class=language-config data-lang=config>Host aliyun
    HostName 192.168.1.100
    User tom
    IdentityFile ~/.ssh/id_rsa
    Port 22
</code></pre><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># ssh $Host 快速连接</span>
</span></span><span class=line><span class=cl>ssh aliyun
</span></span></code></pre></div><h2 id=安全防护>安全防护<a hidden class=anchor aria-hidden=true href=#安全防护>#</a></h2><h3 id=查看连接>查看连接<a hidden class=anchor aria-hidden=true href=#查看连接>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># who 查看当前登录用户的方法。它会显示用户名、终端、登录时间以及远程主机（如果是 SSH 连接）</span>
</span></span><span class=line><span class=cl>who
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ubuntu   pts/0        2025-01-20 17:43 <span class=o>(</span>192.168.64.1<span class=o>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># w 命令提供更详细的信息，包括当前登录用户、他们正在运行的进程、系统负载等。</span>
</span></span><span class=line><span class=cl>w
</span></span><span class=line><span class=cl> 19:44:32 up 14:48,  <span class=m>2</span> users,  load average: 0.06, 0.04, 0.00
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU  WHAT
</span></span><span class=line><span class=cl>ubuntu            192.168.64.1     17:43    3days  0.00s  0.05s sshd: ubuntu <span class=o>[</span>priv<span class=o>]</span>
</span></span><span class=line><span class=cl>ubuntu            192.168.64.1     17:43    3days  0.00s   ?    sshd: ubuntu <span class=o>[</span>priv<span class=o>]</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># last 命令显示最近登录的用户列表，包括用户名、终端、登录时间、远程主机和登出时间</span>
</span></span><span class=line><span class=cl>last
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ubuntu   pts/0        192.168.64.1     Mon Jan <span class=m>20</span> 17:43   still logged in
</span></span><span class=line><span class=cl>ubuntu   pts/0        192.168.64.1     Fri Jan <span class=m>17</span> 11:33 - 11:47  <span class=o>(</span>00:13<span class=o>)</span>
</span></span><span class=line><span class=cl>reboot   system boot  6.8.0-51-generic Fri Jan <span class=m>17</span> 11:33   still running
</span></span><span class=line><span class=cl>reboot   system boot  6.8.0-51-generic Thu Jan  <span class=m>9</span> 16:58 - 17:11  <span class=o>(</span>00:13<span class=o>)</span>
</span></span><span class=line><span class=cl>ubuntu   pts/0        192.168.64.1     Thu Jan  <span class=m>9</span> 16:57 - 16:58  <span class=o>(</span>00:00<span class=o>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># lastlog 命令显示每个用户最后一次登录的时间</span>
</span></span><span class=line><span class=cl>lastlog
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Username         Port     From                                       Latest
</span></span><span class=line><span class=cl>root                                                                **Never logged in**
</span></span><span class=line><span class=cl>daemon                                                              **Never logged in**
</span></span><span class=line><span class=cl>bin                                                                 **Never logged in**
</span></span><span class=line><span class=cl>sys                                                                 **Never logged in**
</span></span><span class=line><span class=cl>ubuntu           pts/0    192.168.64.1                              Mon Jan <span class=m>20</span> 17:43:58 +0800 <span class=m>2025</span>
</span></span></code></pre></div><h3 id=安全策略>安全策略<a hidden class=anchor aria-hidden=true href=#安全策略>#</a></h3><h4 id=pkill-会话>pkill 会话<a hidden class=anchor aria-hidden=true href=#pkill-会话>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ps ajfx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   PPID     PID    PGID     SID TTY        TPGID STAT   UID   TIME COMMAND
</span></span><span class=line><span class=cl><span class=m>1</span> <span class=m>1621867</span> <span class=m>1621867</span> <span class=m>1621867</span> ?             -1 Ss       <span class=m>0</span>   0:49 sshd: /usr/sbin/sshd -D <span class=o>[</span>listener<span class=o>]</span> <span class=m>0</span> of 10-100 sta
</span></span><span class=line><span class=cl><span class=m>1621867</span> <span class=m>2226258</span> <span class=m>2226258</span> <span class=m>2226258</span> ?             -1 Ss       <span class=m>0</span>   0:00  <span class=se>\_</span> sshd: root@pts/5
</span></span><span class=line><span class=cl><span class=m>2226258</span> <span class=m>2226414</span> <span class=m>2226414</span> <span class=m>2226414</span> pts/5    <span class=m>2227480</span> Ss       <span class=m>0</span>   0:00      <span class=se>\_</span> bash --rcfile /dev/fd/63
</span></span><span class=line><span class=cl><span class=m>2226414</span> <span class=m>2227480</span> <span class=m>2227480</span> <span class=m>2226414</span> pts/5    <span class=m>2227480</span> R+       <span class=m>0</span>   0:00          <span class=se>\_</span> ps ajfx
</span></span></code></pre></div><p>通过 SID 可以 kill 掉整个 session，如果 pikill <code>tmux</code> 等软件创建的 session，这些 session 的进程还是会继续运行</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># -e: 显示进程将被终止</span>
</span></span><span class=line><span class=cl><span class=c1># -s: 指定一个或多个会话 ID</span>
</span></span><span class=line><span class=cl><span class=c1># pkill -e -s  $SID</span>
</span></span><span class=line><span class=cl>pkill -e -s <span class=m>2226258</span>
</span></span></code></pre></div><h3 id=排查用户和密钥>排查用户和密钥<a hidden class=anchor aria-hidden=true href=#排查用户和密钥>#</a></h3><p>查看非 root 可登录的账号</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>awk -F: <span class=s1>&#39;BEGIN {OFS=&#34;:&#34;} $3 != 0 &amp;&amp; $7 !~ /\/bin\/false|\/nologin/ {print $1}&#39;</span> /etc/passwd
</span></span></code></pre></div><p>查看允许 ssh 登陆的公钥：</p><p><strong><code>cat ~/.ssh/authorized_keys</code></strong></p><h3 id=禁用密码登陆>禁用密码登陆<a hidden class=anchor aria-hidden=true href=#禁用密码登陆>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>grep PasswordAuthentication /etc/ssh/sshd_config
</span></span></code></pre></div><p>注意：这里是 <code>sshd_config</code>，而不是少了 <code>d</code> 的 <code>ssh_config</code></p><p>如果 <code>/etc/ssh/sshd_config.d</code> 中的某个文件中定义了某个配置选项，那么它会覆盖 <code>/etc/ssh/sshd_config</code> 文件中相同的配置</p><p>例如在 <code>/etc/ssh/sshd_config.d/50-cloud-init.conf</code> 中配置了 <code>PasswordAuthentication yes</code>，那么 <code>/etc/ssh/sshd_config</code> 中修改 <code>PasswordAuthentication</code> 的值都会被覆盖，即密码登陆一直有效，修改为 <code>PasswordAuthentication no</code> 后重新 sshd：<code>sudo systemctl restart sshd</code>，就会提示只允许密钥登陆：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ssh root@192.168.64.6
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@192.168.64.6: Permission denied <span class=o>(</span>publickey<span class=o>)</span>.
</span></span></code></pre></div><p>如果没有关闭密码登陆，就可能会被暴力破解，查询不同用户被尝试登陆的次数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>grep <span class=s2>&#34;Failed password&#34;</span> /var/log/auth.log<span class=p>|</span>perl -e <span class=s1>&#39;while($_=&lt;&gt;){ /for(.*?)from/; print &#34;$1\n&#34;;}&#39;</span><span class=p>|</span>sort<span class=p>|</span>uniq -c<span class=p>|</span>sort -nr
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>   <span class=m>5611</span>  root 
</span></span><span class=line><span class=cl>   <span class=m>2013</span>  invalid user hadoop 
</span></span><span class=line><span class=cl>   <span class=m>1975</span>  invalid user inspur 
</span></span><span class=line><span class=cl>   <span class=m>1973</span>  invalid user cloud 
</span></span><span class=line><span class=cl>    <span class=m>285</span>  invalid user roo 
</span></span><span class=line><span class=cl>    <span class=m>101</span>  invalid user <span class=nb>test</span> 
</span></span><span class=line><span class=cl>     <span class=m>84</span>  invalid user user 
</span></span><span class=line><span class=cl>     <span class=m>72</span>  invalid user admin 
</span></span><span class=line><span class=cl>     <span class=m>68</span>  invalid user oracle 
</span></span><span class=line><span class=cl>     <span class=m>61</span>  invalid user postgres 
</span></span><span class=line><span class=cl>     <span class=m>61</span>  invalid user git 
</span></span><span class=line><span class=cl>     <span class=m>48</span>  invalid user ubuntu 
</span></span><span class=line><span class=cl>     <span class=m>31</span>  invalid user test1 
</span></span><span class=line><span class=cl>     <span class=m>28</span>  invalid user amandabackup 
</span></span><span class=line><span class=cl>     <span class=m>24</span>  invalid user pcpqa 
</span></span><span class=line><span class=cl>     <span class=m>22</span>  invalid user ftpuser 
</span></span><span class=line><span class=cl>     <span class=m>21</span>  invalid user test2 
</span></span><span class=line><span class=cl>     <span class=m>21</span>  invalid user chenly 
</span></span></code></pre></div><p>查询登陆成功的 IP</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>grep <span class=s2>&#34;Accepted&#34;</span> /var/log/auth.log <span class=p>|</span> awk <span class=s1>&#39;{print $11}&#39;</span> <span class=p>|</span> sort <span class=p>|</span> uniq
</span></span></code></pre></div><p>其他安全配置可以参考：</p><p><a href=https://github.com/Just-Hack-For-Fun/Linux-INCIDENT-RESPONSE-COOKBOOK>Linux 应急响应手册 v1.9 - NOP Team</a>
<a href=https://learnku.com/server/t/36120>如何配置安全的 SSH 服务</a>
<a href=https://www.freebuf.com/articles/system/246994.html>SSH安全加固指南</a></p><h2 id=登陆告警>登陆告警<a hidden class=anchor aria-hidden=true href=#登陆告警>#</a></h2><p>在用户登陆时向钉钉发送告警，参考自：<a href=https://blog.k8s.li/linux-login-alarm-telegram.html>VPS 安全加固之用户登录后向 telegram 发送登录信息</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>cd</span> /etc/profile.d/
</span></span><span class=line><span class=cl>vim ssh-login-alerm.sh
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1># 钉钉机器人 Webhook URL</span>
</span></span><span class=line><span class=cl><span class=nv>dingtalk_webhook</span><span class=o>=</span><span class=s2>&#34;https://oapi.dingtalk.com/robot/send?access_token=</span><span class=nv>$token</span><span class=s2>&#34;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取系统信息，并进行转义以避免 JSON 解析错误</span>
</span></span><span class=line><span class=cl><span class=nv>message</span><span class=o>=</span><span class=k>$(</span>hostname <span class=o>&amp;&amp;</span> <span class=nv>TZ</span><span class=o>=</span>UTC-8 date <span class=s1>&#39;+%Y-%m-%d %H:%M:%S&#39;</span> <span class=o>&amp;&amp;</span> who <span class=o>&amp;&amp;</span> w <span class=p>|</span> awk <span class=s1>&#39;BEGIN{OFS=&#34;\t&#34;}{print $1,$8}&#39;</span> <span class=p>|</span> sed <span class=s1>&#39;s/\\/\\\\/g;s/\n/\\n/g;s/&#34;/\\&#34;/g&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用 curl 发送消息到钉钉机器人</span>
</span></span><span class=line><span class=cl>curl -s -X POST <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -H <span class=s2>&#34;Content-Type: application/json&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -d <span class=s2>&#34;{\&#34;msgtype\&#34;:\&#34;text\&#34;,\&#34;text\&#34;:{\&#34;content\&#34;:\&#34;ssh: </span><span class=si>${</span><span class=nv>message</span><span class=si>}</span><span class=s2>\&#34;}}&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=s2>&#34;</span><span class=si>${</span><span class=nv>dingtalk_webhook</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>||</span> <span class=nb>echo</span> <span class=s2>&#34;Error sending DingTalk message.&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#可选：添加日志记录</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;</span><span class=k>$(</span>date <span class=s1>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class=k>)</span><span class=s2> - SSH login detected. Message sent to DingTalk (or error occurred).&#34;</span> &gt;&gt; /var/log/ssh_login_dingtalk.log
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 权限设置为 555 ，这样登陆任何用户都会执行告警</span>
</span></span><span class=line><span class=cl>chmod <span class=m>555</span> /etc/profile.d/ssh-login-alerm.sh
</span></span></code></pre></div><p>登陆后钉钉会收到一条消息:</p><pre tabindex=0><code>ssh: localhost
2025-01-23 22:17:16
root     pts/0        2025-01-23 22:17 (192.168.64.5)
22:17:16	load
USER	WHAT
root	bash
</code></pre><h2 id=参考资料>参考资料<a hidden class=anchor aria-hidden=true href=#参考资料>#</a></h2><p><a href=https://zh.wikipedia.org/wiki/Secure_Shell>Secure Shell - wiki</a>
<a href=https://zh.wikipedia.org/wiki/OpenSSH>OpenSSH - wiki</a>
<a href=https://luciochen.com/archives/189>SSH-Keygen的更安全用法</a>
<a href=https://www.brandonchecketts.com/archives/its-2023-you-should-be-using-an-ed25519-ssh-key-and-other-current-best-practices>It’s 2023. You Should Be Using an Ed25519 SSH Key (And Other Current Best Practices)</a>
<a href=https://www.cnblogs.com/LiuYanYGZ/p/14803012.html>验证远程主机SSH指纹</a>
<a href=https://info.support.huawei.com/info-finder/encyclopedia/zh/SSH.html>什么是SSH？</a>
<a href=https://www.cnblogs.com/diffx/p/9553587.html>图解SSH原理</a>
<a href=https://blog.csdn.net/chen1415886044/article/details/118650286>SSH协议解析及wireshark抓包分析</a>
<a href=https://www.bilibili.com/video/BV13P4y1o76u>SSH协议握手核心过程</a></p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://aaronlinv.github.io/posts/sql-injection/><span class=title>« Prev</span><br><span>永远不要相信用户的输入：从 SQL 注入攻防看输入验证的重要性</span>
</a><a class=next href=https://aaronlinv.github.io/posts/%E9%87%8D%E6%8B%BE-iptables/><span class=title>Next »</span><br><span>重拾 iptables</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://aaronlinv.github.io/>Aaron Lin</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>