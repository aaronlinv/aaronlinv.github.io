<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>SpringBoot 整合 SpringSecurity 梳理 | Aaron Lin</title><meta name=keywords content><meta name=description content='文档
Spring Security Reference
SpringBoot+SpringSecurity+jwt整合及初体验
JSON Web Token 入门教程 - 阮一峰
JWT 官网
SpringSecurity
项目 GitHub 仓库地址：https://github.com/aaronlinv/springsecurity-jwt-demo
依赖
主要用到了: SpringSecurity,Thymeleaf,Web,Lombok
<dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-thymeleaf</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
</dependency>
页面
编写页面和 Controller 进行测试，具体页面可以看 代码
主要包含了首页(index)，订单(order)，还有 user,role,menu这三个位于 /system 下，需要 admin 权限
使用内存用户进行表单登录
在 static 下新建 login.html，用于登录
<form action="/login" method="post">
    <label for="username">账户</label><input type="text" name="username" id="username"><br>
    <label for="password">密码</label><input type="password" name="password" id="password"><br>
    <input type="submit" value="登录">
</form>
编写继承 WebSecurityConfigurerAdapter 的 Security 配置类，并开启 @EnableWebSecurity 注解，这个注解包含了 @Configuration
WebSecurityConfigurerAdapter 中有两个方法，它们名称相同，但是入参不同
protected void configure(HttpSecurity http) throws Exception
protected void configure(AuthenticationManagerBuilder auth) throws Exception
入参为 HttpSecurity 的 configure 可以配置拦截相关的参数
另一个入参为 AuthenticationManagerBuilder，则是用来配置验证相关的参数'><meta name=author content><link rel=canonical href=https://aaronlinv.github.io/posts/springboot-%E6%95%B4%E5%90%88-springsecurity-%E6%A2%B3%E7%90%86/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.2211ca3164be7830024f6aad2b3a2e520843a64f8f048445c3401c1249aa051d.css integrity="sha256-IhHKMWS+eDACT2qtKzouUghDpk+PBIRFw0AcEkmqBR0=" rel="preload stylesheet" as=style><script defer src=https://cloud.umami.is/script.js data-website-id=2afa0ef0-b9a4-4bc7-b673-b5a2e2da51e3></script><link rel=icon href=https://aaronlinv.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://aaronlinv.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://aaronlinv.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://aaronlinv.github.io/apple-touch-icon.png><link rel=mask-icon href=https://aaronlinv.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://aaronlinv.github.io/posts/springboot-%E6%95%B4%E5%90%88-springsecurity-%E6%A2%B3%E7%90%86/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://aaronlinv.github.io/posts/springboot-%E6%95%B4%E5%90%88-springsecurity-%E6%A2%B3%E7%90%86/"><meta property="og:site_name" content="Aaron Lin"><meta property="og:title" content="SpringBoot 整合 SpringSecurity 梳理"><meta property="og:description" content='文档 Spring Security Reference SpringBoot+SpringSecurity+jwt整合及初体验 JSON Web Token 入门教程 - 阮一峰 JWT 官网
SpringSecurity 项目 GitHub 仓库地址：https://github.com/aaronlinv/springsecurity-jwt-demo
依赖 主要用到了: SpringSecurity,Thymeleaf,Web,Lombok
<dependency> <groupId>org.springframework.boot</groupId> <artifactId>spring-boot-starter-security</artifactId> </dependency> <dependency> <groupId>org.springframework.boot</groupId> <artifactId>spring-boot-starter-thymeleaf</artifactId> </dependency> <dependency> <groupId>org.springframework.boot</groupId> <artifactId>spring-boot-starter-web</artifactId> <dependency> <groupId>org.projectlombok</groupId> <artifactId>lombok</artifactId> </dependency> </dependency> 页面 编写页面和 Controller 进行测试，具体页面可以看 代码 主要包含了首页(index)，订单(order)，还有 user,role,menu这三个位于 /system 下，需要 admin 权限
使用内存用户进行表单登录 在 static 下新建 login.html，用于登录
<form action="/login" method="post"> <label for="username">账户</label><input type="text" name="username" id="username"><br> <label for="password">密码</label><input type="password" name="password" id="password"><br> <input type="submit" value="登录"> </form> 编写继承 WebSecurityConfigurerAdapter 的 Security 配置类，并开启 @EnableWebSecurity 注解，这个注解包含了 @Configuration WebSecurityConfigurerAdapter 中有两个方法，它们名称相同，但是入参不同
protected void configure(HttpSecurity http) throws Exception protected void configure(AuthenticationManagerBuilder auth) throws Exception 入参为 HttpSecurity 的 configure 可以配置拦截相关的参数 另一个入参为 AuthenticationManagerBuilder，则是用来配置验证相关的参数'><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-08-24T00:31:33+08:00"><meta property="article:modified_time" content="2021-08-24T00:31:33+08:00"><meta property="og:image" content="https://aaronlinv.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://aaronlinv.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="SpringBoot 整合 SpringSecurity 梳理"><meta name=twitter:description content='文档
Spring Security Reference
SpringBoot+SpringSecurity+jwt整合及初体验
JSON Web Token 入门教程 - 阮一峰
JWT 官网
SpringSecurity
项目 GitHub 仓库地址：https://github.com/aaronlinv/springsecurity-jwt-demo
依赖
主要用到了: SpringSecurity,Thymeleaf,Web,Lombok
<dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-thymeleaf</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
</dependency>
页面
编写页面和 Controller 进行测试，具体页面可以看 代码
主要包含了首页(index)，订单(order)，还有 user,role,menu这三个位于 /system 下，需要 admin 权限
使用内存用户进行表单登录
在 static 下新建 login.html，用于登录
<form action="/login" method="post">
    <label for="username">账户</label><input type="text" name="username" id="username"><br>
    <label for="password">密码</label><input type="password" name="password" id="password"><br>
    <input type="submit" value="登录">
</form>
编写继承 WebSecurityConfigurerAdapter 的 Security 配置类，并开启 @EnableWebSecurity 注解，这个注解包含了 @Configuration
WebSecurityConfigurerAdapter 中有两个方法，它们名称相同，但是入参不同
protected void configure(HttpSecurity http) throws Exception
protected void configure(AuthenticationManagerBuilder auth) throws Exception
入参为 HttpSecurity 的 configure 可以配置拦截相关的参数
另一个入参为 AuthenticationManagerBuilder，则是用来配置验证相关的参数'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://aaronlinv.github.io/posts/"},{"@type":"ListItem","position":2,"name":"SpringBoot 整合 SpringSecurity 梳理","item":"https://aaronlinv.github.io/posts/springboot-%E6%95%B4%E5%90%88-springsecurity-%E6%A2%B3%E7%90%86/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"SpringBoot 整合 SpringSecurity 梳理","name":"SpringBoot 整合 SpringSecurity 梳理","description":"文档 Spring Security Reference SpringBoot+SpringSecurity+jwt整合及初体验 JSON Web Token 入门教程 - 阮一峰 JWT 官网\nSpringSecurity 项目 GitHub 仓库地址：https://github.com/aaronlinv/springsecurity-jwt-demo\n依赖 主要用到了: SpringSecurity,Thymeleaf,Web,Lombok\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-security\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-thymeleaf\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-web\u0026lt;/artifactId\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.projectlombok\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;lombok\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependency\u0026gt; 页面 编写页面和 Controller 进行测试，具体页面可以看 代码 主要包含了首页(index)，订单(order)，还有 user,role,menu这三个位于 /system 下，需要 admin 权限\n使用内存用户进行表单登录 在 static 下新建 login.html，用于登录\n\u0026lt;form action=\u0026#34;/login\u0026#34; method=\u0026#34;post\u0026#34;\u0026gt; \u0026lt;label for=\u0026#34;username\u0026#34;\u0026gt;账户\u0026lt;/label\u0026gt;\u0026lt;input type=\u0026#34;text\u0026#34; name=\u0026#34;username\u0026#34; id=\u0026#34;username\u0026#34;\u0026gt;\u0026lt;br\u0026gt; \u0026lt;label for=\u0026#34;password\u0026#34;\u0026gt;密码\u0026lt;/label\u0026gt;\u0026lt;input type=\u0026#34;password\u0026#34; name=\u0026#34;password\u0026#34; id=\u0026#34;password\u0026#34;\u0026gt;\u0026lt;br\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; value=\u0026#34;登录\u0026#34;\u0026gt; \u0026lt;/form\u0026gt; 编写继承 WebSecurityConfigurerAdapter 的 Security 配置类，并开启 @EnableWebSecurity 注解，这个注解包含了 @Configuration WebSecurityConfigurerAdapter 中有两个方法，它们名称相同，但是入参不同\nprotected void configure(HttpSecurity http) throws Exception protected void configure(AuthenticationManagerBuilder auth) throws Exception 入参为 HttpSecurity 的 configure 可以配置拦截相关的参数 另一个入参为 AuthenticationManagerBuilder，则是用来配置验证相关的参数\n","keywords":[],"articleBody":"文档 Spring Security Reference SpringBoot+SpringSecurity+jwt整合及初体验 JSON Web Token 入门教程 - 阮一峰 JWT 官网\nSpringSecurity 项目 GitHub 仓库地址：https://github.com/aaronlinv/springsecurity-jwt-demo\n依赖 主要用到了: SpringSecurity,Thymeleaf,Web,Lombok\norg.springframework.boot spring-boot-starter-security org.springframework.boot spring-boot-starter-thymeleaf org.springframework.boot spring-boot-starter-web org.projectlombok lombok 页面 编写页面和 Controller 进行测试，具体页面可以看 代码 主要包含了首页(index)，订单(order)，还有 user,role,menu这三个位于 /system 下，需要 admin 权限\n使用内存用户进行表单登录 在 static 下新建 login.html，用于登录\n\u003cform action=\"/login\" method=\"post\"\u003e \u003clabel for=\"username\"\u003e账户\u003c/label\u003e\u003cinput type=\"text\" name=\"username\" id=\"username\"\u003e\u003cbr\u003e \u003clabel for=\"password\"\u003e密码\u003c/label\u003e\u003cinput type=\"password\" name=\"password\" id=\"password\"\u003e\u003cbr\u003e \u003cinput type=\"submit\" value=\"登录\"\u003e \u003c/form\u003e 编写继承 WebSecurityConfigurerAdapter 的 Security 配置类，并开启 @EnableWebSecurity 注解，这个注解包含了 @Configuration WebSecurityConfigurerAdapter 中有两个方法，它们名称相同，但是入参不同\nprotected void configure(HttpSecurity http) throws Exception protected void configure(AuthenticationManagerBuilder auth) throws Exception 入参为 HttpSecurity 的 configure 可以配置拦截相关的参数 另一个入参为 AuthenticationManagerBuilder，则是用来配置验证相关的参数\n@EnableWebSecurity // @Configuration 被包括在上面的注解了 public class SecurityConfig extends WebSecurityConfigurerAdapter { @Bean // 配置 PasswordEncoder 用于密码的加密和匹配 public PasswordEncoder passwordEncoder() { return new BCryptPasswordEncoder(); } @Override protected void configure(HttpSecurity http) throws Exception { // http // 配置表单登录相关参数 .formLogin() // 登录页面 .loginPage(\"/login.html\") // 表单提交的地址 .loginProcessingUrl(\"/login\") // 登录成功后跳转的地址 .defaultSuccessUrl(\"/index\") // .and() 方法返回的是 HttpSecurity 对象 .and() // 配置权限相关参数 .authorizeRequests() // 匹配路径 // 需要开放登录的地址，否则访问登录页面时因为没有权限，自动跳转到登录页，进入死循环，导致报错：重定向的次数过多 .antMatchers(\"/login.html\", \"/login\") // 允许访问 .permitAll() // 匹配路径 .antMatchers(\"/order\") // 必须有指定的任意权限才能访问 .hasAnyAuthority(\"ROLE_user\", \"ROLE_admin\") // 匹配 /system 下的所有路径 .antMatchers(\"/system/**\") // 拥有指定角色才能访问 .hasRole(\"admin\") // 除了上面的路径，其他都需要认证 .anyRequest().authenticated() // 返回 HttpSecurity 对象 .and() // 关闭 csrf （跨站请求伪造） .csrf().disable(); // 设置 注销地址 http.logout().logoutUrl(\"/logout\"); } @Override protected void configure(AuthenticationManagerBuilder auth) throws Exception { // 配置验证 // 使用内存（非持久化）验证 auth.inMemoryAuthentication() // 配置用户名 .withUser(\"user\") // 配置用 PasswordEncoder 加密后的密码 .password(passwordEncoder().encode(\"1234\")) // 配置角色 .roles(\"user\") .and() .withUser(\"admin\") .password(passwordEncoder().encode(\"1234\")) .roles(\"admin\") .and() // 配置授权时默认使用的 PasswordEncoder .passwordEncoder(passwordEncoder()); ; } } 具体代码参考 这里 两个 configure 非常类似，入参对象的方法中包含了具体的配置项，如：formLogin,authorizeRequests,csrf,logout 等等，部分配置项还可以通过链式调用，进行该配置项更详细地配置，通过 .and() 可以回到 HttpSecurity 对象，再定义其他配置项\n使用表单的方式登录需要配置：表单 (formLogin)、授权(authorizeRequests) 、跨站请求伪造(csrf)、注销(logout)，还需要配置验证，先使用最简单的 inMemoryAuthentication，并指定账户密码，再指定密码编码器\n然后启动服务，访问登录页面（注意这里的被修改为 8081），输入不同的账号密码，测试不同页面的访问情况，没有权限会提示：403 http://localhost:8081/login.html\n使用 Json 传递参数，自定义 Handler 修改登录页面，使用 Ajax 向后端传递 账户和密码，需要使用 POST\n\u003chead\u003e \u003cmeta charset=\"UTF-8\"\u003e \u003ctitle\u003e登录\u003c/title\u003e \u003cscript src=\"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.js\"\u003e\u003c/script\u003e \u003c/head\u003e \u003cbody\u003e \u003cform action=\"/login\" method=\"post\"\u003e \u003clabel for=\"username\"\u003e账户\u003c/label\u003e\u003cinput type=\"text\" name=\"username\" id=\"username\"\u003e\u003cbr\u003e \u003clabel for=\"password\"\u003e密码\u003c/label\u003e\u003cinput type=\"password\" name=\"password\" id=\"password\"\u003e\u003cbr\u003e \u003cinput type=\"submit\" onclick=\"login()\" value=\"登录\"\u003e \u003c/form\u003e \u003c/body\u003e \u003cscript\u003e function login() { $.ajax({ type: \"POST\", url: \"/login\", data: { \"username\": $(\"#username\").val(), \"password\": $(\"#password\").val(), }, success: function (data) { if (data.code == 20001) { Location.href = \"/index\"; } else { alert(data.msg); } } }) } \u003c/script\u003e 需要编写登录成功和登录失败时调用的 Handler，并配置到SecurityConfig 中\n@Component public class MyAuthenticationFailureHandler implements AuthenticationFailureHandler { @Override public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) throws IOException, ServletException { response.setContentType(\"application/json; charset=UTF-8\"); PrintWriter writer = response.getWriter(); writer.write(\"{\\\"code\\\":\\\"40001\\\",\\\"msg\\\":\\\"登录失败\\\"}\"); writer.flush(); writer.close(); } } @Component public class MyAuthenticationSuccessHandler implements AuthenticationSuccessHandler { @Override public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException { response.setContentType(\"application/json; charset=UTF-8\"); PrintWriter writer = response.getWriter(); writer.write(\"{\\\"code\\\":\\\"20001\\\",\\\"msg\\\":\\\"登录成功\\\"}\"); writer.flush(); writer.close(); } } 在 SecurityConfig 中 注入并配置 Handler\n@Autowired private AuthenticationSuccessHandler successHandler; @Autowired private AuthenticationFailureHandler failureHandler; @Override protected void configure(HttpSecurity http) throws Exception { http.formLogin() .loginPage(\"/login.html\") .loginProcessingUrl(\"/login\") // 指定 Handler .successHandler(successHandler) .failureHandler(failureHandler) // 省略其他代码... } 具体代码参考 这里 登录页面进行测试：http://localhost:8081/login.html 首页:http://localhost:8081/\n基于数据库的认证 创建数据库 jwt_demo ，导入表数据：sql 脚本 users 表，包括字段：user_id,user_name,password,status,roles 导入 MySQL 驱动和 JPA 的依赖\nmysql mysql-connector-java runtime org.springframework.boot spring-boot-starter-data-jpa 在 application.properties 中配置数据库信息\nserver.port=8081 spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver spring.datasource.username=root spring.datasource.password=1234 spring.datasource.url=jdbc:mysql://localhost:3306/jwt_demo?serverTimezone=GMT%2B8\u0026characterEncoding=utf-8 UserDetails 接口是 SpringSecurity 用来承载用户信息的载体，SpringSecurity 提供了对这个接口的实现类：org.springframework.security.core.userdetails.User，我们自己定义的用户类通常也叫User，所以导包时候要注意使用 我们自己定义的 User 类\n@Entity @Table(name = \"users\") @Data @AllArgsConstructor @NoArgsConstructor public class User implements UserDetails { @Id @GeneratedValue(strategy = GenerationType.IDENTITY) @Column private Long userId; @Column(name = \"user_name\") private String userName; @Column(name = \"password\") private String password; @Column(name = \"status\") private String status; @Column(name = \"roles\") private String roles; // 对象的权限列表，不需要持久化 @Transient private List\u003cGrantedAuthority\u003e authorities; public void setAuthorities(List\u003cGrantedAuthority\u003e authorities) { this.authorities = authorities; } // 必须重写接口的对于 getPassword,getUsername,getAuthorities 等方法 @Override public Collection\u003c? extends GrantedAuthority\u003e getAuthorities() { return this.authorities; } @Override public String getUsername() { return this.userName; } // 下面 4 个需要方法 return true，否则登录时会被限制 @Override public boolean isAccountNonExpired() { return true; } @Override public boolean isAccountNonLocked() { return true; } @Override public boolean isCredentialsNonExpired() { return true; } @Override public boolean isEnabled() { return true; } } 定义 JPA 的 Repository\n@Repository public interface UserDao extends JpaRepository\u003cUser, Long\u003e { } 定义 Service\npublic interface UserService { public User selectUserByUserName(String username); } 定义 Service 对应的实现，通过查询用户名获得用户相关信息\n@Service public class UserServiceImpl implements UserService { @Autowired private UserDao userDao; @Override public User selectUserByUserName(String username) { User user = new User(); user.setUserName(username); List\u003cUser\u003e list = userDao.findAll(Example.of(user)); return list.isEmpty() ? null : list.get(0); } } 还需要编写 UserDetailService，供 SpringSecurity 的 DaoAuthenticationProvider 类中的 retrieveUser 方法调用，以此获得对应用户的信息\n@Service public class UserDetailService implements UserDetailsService { @Autowired private UserService userService; @Override public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException { // 调用 Service User user = userService.selectUserByUserName(username); if (user == null) { throw new UsernameNotFoundException(\"用户\" + user.getUsername() + \"不存在\"); } // 设置权限 // commaSeparatedStringToAuthorityList 方式将字符串间通过 ',' 进行分割，然后返回 List user.setAuthorities(AuthorityUtils.commaSeparatedStringToAuthorityList(user.getRoles())); return user; } } // 省略其他... public class SecurityConfig extends WebSecurityConfigurerAdapter { @Autowired private UserDetailService userDetailService; @Override protected void configure(AuthenticationManagerBuilder auth) throws Exception { // 将内存授权方式替换为自己实现的 UserDetailService auth.userDetailsService(userDetailService) .passwordEncoder(passwordEncoder()); // 省略其他... } 具体代码参考 这里\n登录页面进行测试：http://localhost:8081/login.html 首页:http://localhost:8081/\n整合 JWT 添加 jjwt 依赖\nio.jsonwebtoken jjwt 0.9.0 在 application.properties 中配置 JWT 参数\ntoken.header:Authorization # 令牌秘钥 token.secret:askdhfkjahskjdfhkalsjhdf^112asdfasdf44^%$_@+asdfasdfaskjdhfkjashdfljkahsdklsfjasgdkjfgjahs(IS:)_@@+asdfasdfaskjdhfkjashdfljkahsdklsfja@+asdfasdfaskjdhfkjashdfljkahsdklsfjasgdkjfgjahssgdkjfgjahsdgfjhgsdfsadf+-asdfasdas+as++_sdfsdsasdfasdf # 令牌有效期（默认30分钟） token.expireTime:3600000 定义统一 API 封装格式\npublic class RestResult extends HashMap\u003cString, Object\u003e { private static final long serialVersionUID = 1L; // 状态码 public static final String CODE_TAG = \"code\"; // 返回内容 public static final String MSG_TAG = \"msg\"; // 数据对象 public static final String DATA_TAG = \"data\"; public RestResult() { } public RestResult(int code, String msg) { super.put(CODE_TAG, code); super.put(MSG_TAG, msg); } public RestResult(int code, String msg, Object data) { super.put(CODE_TAG, code); super.put(MSG_TAG, msg); if (data != null) { super.put(DATA_TAG, data); } } public static RestResult success() { return new RestResult(200, \"成功\"); } } 然后准备 JWT 工具类，实现：生成 token、从 token 中获取用户名、检查 token 是否过期、刷新 token、验证 token 等，这里的 KEY 通过双重锁 保证了线程安全\n@Data @Component @Slf4j public class JwtTokenUtils { @Value(\"${token.secret}\") private String secret; @Value(\"${token.expireTime}\") private Long expiration; @Value(\"${token.header}\") private String header; private static Key KEY = null; /** * 生成token令牌 * * @param userDetails 用户 * @return 令token牌 */ public String generateToken(UserDetails userDetails) { log.info(\"[JwtTokenUtils] generateToken \" + userDetails.toString()); Map\u003cString, Object\u003e claims = new HashMap\u003c\u003e(2); claims.put(\"sub\", userDetails.getUsername()); claims.put(\"created\", new Date()); return generateToken(claims); } /** * 从令牌中获取用户名 * * @param token 令牌 * @return 用户名 */ public String getUsernameFromToken(String token) { String username = null; try { Claims claims = getClaimsFromToken(token); username = claims.get(\"sub\", String.class); log.info(\"从令牌中获取用户名:\" + username); } catch (Exception e) { username = null; } return username; } /** * 判断令牌是否过期 * * @param token 令牌 * @return 是否过期 */ public Boolean isTokenExpired(String token) { try { Claims claims = getClaimsFromToken(token); Date expiration = claims.getExpiration(); return expiration.before(new Date()); } catch (Exception e) { return false; } } /** * 刷新令牌 * * @param token 原令牌 * @return 新令牌 */ public String refreshToken(String token) { String refreshedToken; try { Claims claims = getClaimsFromToken(token); claims.put(\"created\", new Date()); refreshedToken = generateToken(claims); } catch (Exception e) { refreshedToken = null; } return refreshedToken; } /** * 验证令牌 * * @param token 令牌 * @param userDetails 用户 * @return 是否有效 */ public Boolean validateToken(String token, UserDetails userDetails) { String username = getUsernameFromToken(token); return (username.equals(userDetails.getUsername()) \u0026\u0026 !isTokenExpired(token)); } /** * 从claims生成令牌 * * @param claims 数据声明 * @return 令牌 */ private String generateToken(Map\u003cString, Object\u003e claims) { Date expirationDate = new Date(System.currentTimeMillis() + expiration); return Jwts.builder().setClaims(claims) .setExpiration(expirationDate) .signWith(SignatureAlgorithm.HS256, getKeyInstance()) .compact(); } /** * 从令牌中获取数据声明 * * @param token 令牌 * @return 数据声明 */ private Claims getClaimsFromToken(String token) { Claims claims = null; try { claims = Jwts.parser().setSigningKey(getKeyInstance()).parseClaimsJws(token).getBody(); } catch (Exception e) { claims = null; } return claims; } private Key getKeyInstance() { if (KEY == null) { synchronized (JwtTokenUtils.class) { if (KEY == null) {// 双重锁 byte[] apiKeySecretBytes = DatatypeConverter.parseBase64Binary(secret); KEY = new SecretKeySpec(apiKeySecretBytes, SignatureAlgorithm.HS256.getJcaName()); } } } return KEY; } } 然后定义 JwtAuthTokenFilter，用于过滤请求\n@Component public class JwtAuthTokenFilter extends OncePerRequestFilter { @Autowired private UserDetailsService userDetailsService; @Autowired private JwtTokenUtils jwtTokenUtils; @Override protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain) throws ServletException, IOException { // 从请求头中获取 Authorization 的值，即 token String jwtToken = request.getHeader(jwtTokenUtils.getHeader()); if (!ObjectUtils.isEmpty(jwtToken)) { // 从 token 中获取用户名，用户名存储在负载中，负载一般没有加密，所以负载的内容是可以见，不能在其中存放敏感信息 // 可以通过 https://jwt.io/ 进行解码 String username = jwtTokenUtils.getUsernameFromToken(jwtToken); if (username != null \u0026\u0026 SecurityContextHolder.getContext().getAuthentication() == null) { // 通过 userDetailsService 从数据库中获取对应用户的信息 UserDetails userDetails = userDetailsService.loadUserByUsername(username); // 这里校验 token 有效性 if (jwtTokenUtils.validateToken(jwtToken, userDetails)) { // 将 UserDetails 对象 封装为 UsernamePasswordAuthenticationToken 对象 // 第一参数是 Object principal，传入的是 UserDetails 对象，在后面的 Service 中会取出 principal UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities()); // 交给SpringSecurity管理，在之后的过滤器不会被拦截进行二次授权了 SecurityContextHolder.getContext().setAuthentication(authenticationToken); } } } // 将请求转发给过滤器链上的下一个对象 chain.doFilter(request, response); } } 编写 JwtAuthService，处理登录的相关逻辑，使用 AuthenticationManager 对传入的账号密码进行认证，成功返回 生成的 token\n@Service public class JwtAuthService { @Autowired private JwtTokenUtils jwtTokenUtils; @Autowired private AuthenticationManager authenticationManager; public String login(String username, String password) { Authentication authentication = null; try { authentication = authenticationManager.authenticate(new UsernamePasswordAuthenticationToken(username, password)); } catch (Exception e) { throw new RuntimeException(\"用户名或密码有误\"); } // 这里就是获取的就是在前面 JwtAuthTokenFilter 中传入的 principal User loginUser = (User) authentication.getPrincipal(); return jwtTokenUtils.generateToken(loginUser); } } 用于登录的 Controller\n@RestController public class JwtLoginController { @Autowired private JwtAuthService jwtAuthService; @PostMapping({\"/login\", \"/\"}) public RestResult login(String username, String password) { RestResult result = RestResult.success(); String token = jwtAuthService.login(username, password); result.put(\"token\", token); return result; } } 在 SecurityConfig 中 注入并配置 Handler\n// 省略其他代码... @Autowired private JwtAuthTokenFilter jwtAuthTokenFilter; // 重写 AuthenticationManager，避免报错 @Override @Bean public AuthenticationManager authenticationManagerBean() throws Exception { return super.authenticationManagerBean(); } @Override protected void configure(HttpSecurity http) throws Exception { // http.formLogin() // .loginPage(\"/login.html\") // .loginProcessingUrl(\"/login\") // // .defaultSuccessUrl(\"/index\") // // .defaultSuccessUrl(\"/index\") // .successHandler(successHandler) // .failureHandler(failureHandler) http.sessionManagement() // 不创建和使用 session .sessionCreationPolicy(SessionCreationPolicy.STATELESS) .and() .authorizeRequests() .antMatchers(\"/login\") .anonymous() .antMatchers(HttpMethod.GET, \"/*.html\", \"/**/*.html\", \"/**/*.css\", \"/**/*.js\") .permitAll() // 省略其他代码... // 使用 JWT 过滤器 http.addFilterBefore(jwtAuthTokenFilter, UsernamePasswordAuthenticationFilter.class); } // 省略其他代码... 可以通过 Postman 先指定参数（注意是用 POST），获取 token： http://localhost:8081/login?username=user\u0026password=1234\n在 Headers 中添加 Authorization，值为获取到的 token 使用 GET 访问：http://localhost:8081/order 因为 user 没有管理权限，所以访问管理页面会 403：http://localhost:8081/system/role\n具体代码参考 这里\n","wordCount":"1489","inLanguage":"en","image":"https://aaronlinv.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2021-08-24T00:31:33+08:00","dateModified":"2021-08-24T00:31:33+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://aaronlinv.github.io/posts/springboot-%E6%95%B4%E5%90%88-springsecurity-%E6%A2%B3%E7%90%86/"},"publisher":{"@type":"Organization","name":"Aaron Lin","logo":{"@type":"ImageObject","url":"https://aaronlinv.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://aaronlinv.github.io/ accesskey=h title="Aaron's Blog (Alt + H)">Aaron's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://aaronlinv.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://aaronlinv.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://aaronlinv.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://aaronlinv.github.io/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">SpringBoot 整合 SpringSecurity 梳理</h1><div class=post-meta><span title='2021-08-24 00:31:33 +0800 +0800'>August 24, 2021</span></div></header><div class=post-content><h2 id=文档>文档<a hidden class=anchor aria-hidden=true href=#文档>#</a></h2><p><a href=https://docs.spring.io/spring-security/site/docs/current/reference/html5/>Spring Security Reference</a>
<a href=https://www.cnblogs.com/pjjlt/p/10960690.html>SpringBoot+SpringSecurity+jwt整合及初体验</a>
<a href=https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html>JSON Web Token 入门教程 - 阮一峰</a>
<a href=https://jwt.io/>JWT 官网</a></p><h2 id=springsecurity>SpringSecurity<a hidden class=anchor aria-hidden=true href=#springsecurity>#</a></h2><p>项目 GitHub 仓库地址：<a href=https://github.com/aaronlinv/springsecurity-jwt-demo>https://github.com/aaronlinv/springsecurity-jwt-demo</a></p><h3 id=依赖>依赖<a hidden class=anchor aria-hidden=true href=#依赖>#</a></h3><p>主要用到了: SpringSecurity,Thymeleaf,Web,Lombok</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-security<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-thymeleaf<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-web<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;groupId&gt;</span>org.projectlombok<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;artifactId&gt;</span>lombok<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id=页面>页面<a hidden class=anchor aria-hidden=true href=#页面>#</a></h3><p>编写页面和 Controller 进行测试，具体页面可以看 <a href=https://github.com/aaronlinv/springsecurity-jwt-demo/commit/a3653a02ab9e074d0e25387cf387b2b338353d8d>代码</a>
主要包含了首页(index)，订单(order)，还有 user,role,menu这三个位于 <code>/system</code> 下，需要 admin 权限</p><h3 id=使用内存用户进行表单登录>使用内存用户进行表单登录<a hidden class=anchor aria-hidden=true href=#使用内存用户进行表单登录>#</a></h3><p>在 <code>static</code> 下新建 <code>login.html</code>，用于登录</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=s>&#34;/login&#34;</span> <span class=na>method</span><span class=o>=</span><span class=s>&#34;post&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>label</span> <span class=na>for</span><span class=o>=</span><span class=s>&#34;username&#34;</span><span class=p>&gt;</span>账户<span class=p>&lt;/</span><span class=nt>label</span><span class=p>&gt;&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;username&#34;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;username&#34;</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>label</span> <span class=na>for</span><span class=o>=</span><span class=s>&#34;password&#34;</span><span class=p>&gt;</span>密码<span class=p>&lt;/</span><span class=nt>label</span><span class=p>&gt;&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;password&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;password&#34;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;password&#34;</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;登录&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>编写继承 WebSecurityConfigurerAdapter 的 Security 配置类，并开启 @EnableWebSecurity 注解，这个注解包含了 @Configuration
WebSecurityConfigurerAdapter 中有两个方法，它们名称相同，但是入参不同</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>configure</span><span class=p>(</span><span class=n>HttpSecurity</span><span class=w> </span><span class=n>http</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>configure</span><span class=p>(</span><span class=n>AuthenticationManagerBuilder</span><span class=w> </span><span class=n>auth</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w>
</span></span></span></code></pre></div><p>入参为 HttpSecurity 的 configure 可以配置拦截相关的参数
另一个入参为 AuthenticationManagerBuilder，则是用来配置验证相关的参数</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@EnableWebSecurity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// @Configuration 被包括在上面的注解了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SecurityConfig</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>WebSecurityConfigurerAdapter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 配置 PasswordEncoder 用于密码的加密和匹配</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>PasswordEncoder</span><span class=w> </span><span class=nf>passwordEncoder</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BCryptPasswordEncoder</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>configure</span><span class=p>(</span><span class=n>HttpSecurity</span><span class=w> </span><span class=n>http</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 配置表单登录相关参数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>formLogin</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 登录页面</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>loginPage</span><span class=p>(</span><span class=s>&#34;/login.html&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 表单提交的地址</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>loginProcessingUrl</span><span class=p>(</span><span class=s>&#34;/login&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 登录成功后跳转的地址</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>defaultSuccessUrl</span><span class=p>(</span><span class=s>&#34;/index&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// .and() 方法返回的是 HttpSecurity 对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>and</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 配置权限相关参数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>authorizeRequests</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 匹配路径</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 需要开放登录的地址，否则访问登录页面时因为没有权限，自动跳转到登录页，进入死循环，导致报错：重定向的次数过多</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>antMatchers</span><span class=p>(</span><span class=s>&#34;/login.html&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;/login&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 允许访问</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>permitAll</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 匹配路径</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>antMatchers</span><span class=p>(</span><span class=s>&#34;/order&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 必须有指定的任意权限才能访问</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>hasAnyAuthority</span><span class=p>(</span><span class=s>&#34;ROLE_user&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;ROLE_admin&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 匹配 /system 下的所有路径</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>antMatchers</span><span class=p>(</span><span class=s>&#34;/system/**&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 拥有指定角色才能访问</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>hasRole</span><span class=p>(</span><span class=s>&#34;admin&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 除了上面的路径，其他都需要认证</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>anyRequest</span><span class=p>().</span><span class=na>authenticated</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 返回 HttpSecurity 对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>and</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 关闭 csrf （跨站请求伪造）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>csrf</span><span class=p>().</span><span class=na>disable</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 设置 注销地址</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>http</span><span class=p>.</span><span class=na>logout</span><span class=p>().</span><span class=na>logoutUrl</span><span class=p>(</span><span class=s>&#34;/logout&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>configure</span><span class=p>(</span><span class=n>AuthenticationManagerBuilder</span><span class=w> </span><span class=n>auth</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 配置验证</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 使用内存（非持久化）验证</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>auth</span><span class=p>.</span><span class=na>inMemoryAuthentication</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 配置用户名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>withUser</span><span class=p>(</span><span class=s>&#34;user&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 配置用 PasswordEncoder 加密后的密码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>password</span><span class=p>(</span><span class=n>passwordEncoder</span><span class=p>().</span><span class=na>encode</span><span class=p>(</span><span class=s>&#34;1234&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 配置角色</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>roles</span><span class=p>(</span><span class=s>&#34;user&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>and</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>withUser</span><span class=p>(</span><span class=s>&#34;admin&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>password</span><span class=p>(</span><span class=n>passwordEncoder</span><span class=p>().</span><span class=na>encode</span><span class=p>(</span><span class=s>&#34;1234&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>roles</span><span class=p>(</span><span class=s>&#34;admin&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>and</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 配置授权时默认使用的 PasswordEncoder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>passwordEncoder</span><span class=p>(</span><span class=n>passwordEncoder</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>具体代码参考 <a href=https://github.com/aaronlinv/springsecurity-jwt-demo/commit/fe65f3ec57383be6fc7d8f7425c41bb666b27281>这里</a>
两个 configure 非常类似，入参对象的方法中包含了具体的配置项，如：<code>formLogin</code>,<code>authorizeRequests</code>,<code>csrf</code>,<code>logout</code> 等等，部分配置项还可以通过链式调用，进行该配置项更详细地配置，通过 <code>.and()</code> 可以回到 HttpSecurity 对象，再定义其他配置项</p><p>使用表单的方式登录需要配置：表单 (formLogin)、授权(authorizeRequests) 、跨站请求伪造(csrf)、注销(logout)，还需要配置验证，先使用最简单的 inMemoryAuthentication，并指定账户密码，再指定密码编码器</p><p>然后启动服务，访问登录页面（注意这里的被修改为 8081），输入不同的账号密码，测试不同页面的访问情况，没有权限会提示：403
<a href=http://localhost:8081/login.html>http://localhost:8081/login.html</a></p><h3 id=使用-json-传递参数自定义-handler>使用 Json 传递参数，自定义 Handler<a hidden class=anchor aria-hidden=true href=#使用-json-传递参数自定义-handler>#</a></h3><p>修改登录页面，使用 Ajax 向后端传递 账户和密码，需要使用 POST</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>登录<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=s>&#34;/login&#34;</span> <span class=na>method</span><span class=o>=</span><span class=s>&#34;post&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>label</span> <span class=na>for</span><span class=o>=</span><span class=s>&#34;username&#34;</span><span class=p>&gt;</span>账户<span class=p>&lt;/</span><span class=nt>label</span><span class=p>&gt;&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;username&#34;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;username&#34;</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>label</span> <span class=na>for</span><span class=o>=</span><span class=s>&#34;password&#34;</span><span class=p>&gt;</span>密码<span class=p>&lt;/</span><span class=nt>label</span><span class=p>&gt;&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;password&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;password&#34;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;password&#34;</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span> <span class=na>onclick</span><span class=o>=</span><span class=s>&#34;login()&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;登录&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nx>login</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>$</span><span class=p>.</span><span class=nx>ajax</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;POST&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/login&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>data</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;username&#34;</span><span class=o>:</span> <span class=nx>$</span><span class=p>(</span><span class=s2>&#34;#username&#34;</span><span class=p>).</span><span class=nx>val</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;password&#34;</span><span class=o>:</span> <span class=nx>$</span><span class=p>(</span><span class=s2>&#34;#password&#34;</span><span class=p>).</span><span class=nx>val</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nx>success</span><span class=o>:</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>code</span> <span class=o>==</span> <span class=mi>20001</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>Location</span><span class=p>.</span><span class=nx>href</span> <span class=o>=</span> <span class=s2>&#34;/index&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>alert</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>msg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>需要编写登录成功和登录失败时调用的 Handler，并配置到SecurityConfig 中</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyAuthenticationFailureHandler</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>AuthenticationFailureHandler</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onAuthenticationFailure</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>AuthenticationException</span><span class=w> </span><span class=n>exception</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ServletException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>response</span><span class=p>.</span><span class=na>setContentType</span><span class=p>(</span><span class=s>&#34;application/json; charset=UTF-8&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>PrintWriter</span><span class=w> </span><span class=n>writer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>response</span><span class=p>.</span><span class=na>getWriter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>writer</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=s>&#34;{\&#34;code\&#34;:\&#34;40001\&#34;,\&#34;msg\&#34;:\&#34;登录失败\&#34;}&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>writer</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>writer</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyAuthenticationSuccessHandler</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>AuthenticationSuccessHandler</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onAuthenticationSuccess</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>Authentication</span><span class=w> </span><span class=n>authentication</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ServletException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>response</span><span class=p>.</span><span class=na>setContentType</span><span class=p>(</span><span class=s>&#34;application/json; charset=UTF-8&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>PrintWriter</span><span class=w> </span><span class=n>writer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>response</span><span class=p>.</span><span class=na>getWriter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>writer</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=s>&#34;{\&#34;code\&#34;:\&#34;20001\&#34;,\&#34;msg\&#34;:\&#34;登录成功\&#34;}&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>writer</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>writer</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>在 SecurityConfig 中 注入并配置 Handler</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>AuthenticationSuccessHandler</span><span class=w> </span><span class=n>successHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>AuthenticationFailureHandler</span><span class=w> </span><span class=n>failureHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>configure</span><span class=p>(</span><span class=n>HttpSecurity</span><span class=w> </span><span class=n>http</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>http</span><span class=p>.</span><span class=na>formLogin</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>loginPage</span><span class=p>(</span><span class=s>&#34;/login.html&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>loginProcessingUrl</span><span class=p>(</span><span class=s>&#34;/login&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 指定 Handler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>successHandler</span><span class=p>(</span><span class=n>successHandler</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>failureHandler</span><span class=p>(</span><span class=n>failureHandler</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 省略其他代码...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>具体代码参考 <a href=https://github.com/aaronlinv/springsecurity-jwt-demo/commit/d2badb8ea02fa092c3452a9f06c4105f1df1c15d>这里</a>
登录页面进行测试：<a href=http://localhost:8081/login.html>http://localhost:8081/login.html</a>
首页:<a href=http://localhost:8081/>http://localhost:8081/</a></p><h3 id=基于数据库的认证>基于数据库的认证<a hidden class=anchor aria-hidden=true href=#基于数据库的认证>#</a></h3><p>创建数据库 <code>jwt_demo</code> ，导入表数据：<a href=https://github.com/aaronlinv/springsecurity-jwt-demo/blob/master/jwt_demo.sql>sql 脚本</a>
users 表，包括字段：user_id,user_name,password,status,roles
导入 MySQL 驱动和 JPA 的依赖</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>        <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;groupId&gt;</span>mysql<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;artifactId&gt;</span>mysql-connector-java<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;scope&gt;</span>runtime<span class=nt>&lt;/scope&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-data-jpa<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>在 application.properties 中配置数据库信息</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>server.port</span><span class=o>=</span><span class=s>8081</span>
</span></span><span class=line><span class=cl><span class=na>spring.datasource.driver-class-name</span><span class=o>=</span><span class=s>com.mysql.cj.jdbc.Driver</span>
</span></span><span class=line><span class=cl><span class=na>spring.datasource.username</span><span class=o>=</span><span class=s>root</span>
</span></span><span class=line><span class=cl><span class=na>spring.datasource.password</span><span class=o>=</span><span class=s>1234</span>
</span></span><span class=line><span class=cl><span class=na>spring.datasource.url</span><span class=o>=</span><span class=s>jdbc:mysql://localhost:3306/jwt_demo?serverTimezone=GMT%2B8&amp;characterEncoding=utf-8</span>
</span></span></code></pre></div><p>UserDetails 接口是 SpringSecurity 用来承载用户信息的载体，SpringSecurity 提供了对这个接口的实现类：org.springframework.security.core.userdetails.User，我们自己定义的用户类通常也叫User，所以导包时候要注意使用 我们自己定义的 User 类</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Entity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Table</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;users&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@AllArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@NoArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>User</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserDetails</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GeneratedValue</span><span class=p>(</span><span class=n>strategy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GenerationType</span><span class=p>.</span><span class=na>IDENTITY</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Column</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Column</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;user_name&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>userName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Column</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;password&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Column</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;status&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Column</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;roles&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>roles</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 对象的权限列表，不需要持久化</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Transient</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>GrantedAuthority</span><span class=o>&gt;</span><span class=w> </span><span class=n>authorities</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setAuthorities</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>GrantedAuthority</span><span class=o>&gt;</span><span class=w> </span><span class=n>authorities</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>authorities</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>authorities</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 必须重写接口的对于 getPassword,getUsername,getAuthorities 等方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Collection</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>GrantedAuthority</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getAuthorities</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>authorities</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getUsername</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>userName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 下面 4 个需要方法 return true，否则登录时会被限制</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isAccountNonExpired</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isAccountNonLocked</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isCredentialsNonExpired</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isEnabled</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>定义 JPA 的 Repository</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Repository</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>UserDao</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>JpaRepository</span><span class=o>&lt;</span><span class=n>User</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>定义 Service</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>User</span><span class=w> </span><span class=nf>selectUserByUserName</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>定义 Service 对应的实现，通过查询用户名获得用户相关信息</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>UserDao</span><span class=w> </span><span class=n>userDao</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>User</span><span class=w> </span><span class=nf>selectUserByUserName</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>User</span><span class=w> </span><span class=n>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>User</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>user</span><span class=p>.</span><span class=na>setUserName</span><span class=p>(</span><span class=n>username</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>userDao</span><span class=p>.</span><span class=na>findAll</span><span class=p>(</span><span class=n>Example</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=n>user</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>list</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>list</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>还需要编写 UserDetailService，供 SpringSecurity 的 DaoAuthenticationProvider 类中的 retrieveUser 方法调用，以此获得对应用户的信息</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserDetailService</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>UserDetailsService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>UserService</span><span class=w> </span><span class=n>userService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>UserDetails</span><span class=w> </span><span class=nf>loadUserByUsername</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>UsernameNotFoundException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 调用 Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>User</span><span class=w> </span><span class=n>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>userService</span><span class=p>.</span><span class=na>selectUserByUserName</span><span class=p>(</span><span class=n>username</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>user</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UsernameNotFoundException</span><span class=p>(</span><span class=s>&#34;用户&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>user</span><span class=p>.</span><span class=na>getUsername</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;不存在&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 设置权限</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// commaSeparatedStringToAuthorityList 方式将字符串间通过 &#39;,&#39; 进行分割，然后返回 List</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>user</span><span class=p>.</span><span class=na>setAuthorities</span><span class=p>(</span><span class=n>AuthorityUtils</span><span class=p>.</span><span class=na>commaSeparatedStringToAuthorityList</span><span class=p>(</span><span class=n>user</span><span class=p>.</span><span class=na>getRoles</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>user</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 省略其他...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SecurityConfig</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>WebSecurityConfigurerAdapter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>UserDetailService</span><span class=w> </span><span class=n>userDetailService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>configure</span><span class=p>(</span><span class=n>AuthenticationManagerBuilder</span><span class=w> </span><span class=n>auth</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 将内存授权方式替换为自己实现的 UserDetailService</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>auth</span><span class=p>.</span><span class=na>userDetailsService</span><span class=p>(</span><span class=n>userDetailService</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>passwordEncoder</span><span class=p>(</span><span class=n>passwordEncoder</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 省略其他...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>具体代码参考 <a href=https://github.com/aaronlinv/springsecurity-jwt-demo/commit/97f9d10c9f7ae5f193d75dd8ca8d16ee8dedc9c4>这里</a></p><p>登录页面进行测试：<a href=http://localhost:8081/login.html>http://localhost:8081/login.html</a>
首页:<a href=http://localhost:8081>http://localhost:8081/</a></p><h3 id=整合-jwt>整合 JWT<a hidden class=anchor aria-hidden=true href=#整合-jwt>#</a></h3><p>添加 jjwt 依赖</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>        <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;groupId&gt;</span>io.jsonwebtoken<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;artifactId&gt;</span>jjwt<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;version&gt;</span>0.9.0<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>在 application.properties 中配置 JWT 参数</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>token.header</span><span class=o>:</span><span class=s>Authorization</span>
</span></span><span class=line><span class=cl><span class=c1>#  令牌秘钥</span>
</span></span><span class=line><span class=cl><span class=na>token.secret</span><span class=o>:</span><span class=s>askdhfkjahskjdfhkalsjhdf^112asdfasdf44^%$_@+asdfasdfaskjdhfkjashdfljkahsdklsfjasgdkjfgjahs(IS:)_@@+asdfasdfaskjdhfkjashdfljkahsdklsfja@+asdfasdfaskjdhfkjashdfljkahsdklsfjasgdkjfgjahssgdkjfgjahsdgfjhgsdfsadf+-asdfasdas+as++_sdfsdsasdfasdf</span>
</span></span><span class=line><span class=cl><span class=c1>#   令牌有效期（默认30分钟）</span>
</span></span><span class=line><span class=cl><span class=na>token.expireTime</span><span class=o>:</span><span class=s>3600000</span>
</span></span></code></pre></div><p>定义统一 API 封装格式</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RestResult</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>serialVersionUID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1L</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 状态码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>CODE_TAG</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;code&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 返回内容</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>MSG_TAG</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;msg&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 数据对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>DATA_TAG</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;data&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>RestResult</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>RestResult</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>code</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>CODE_TAG</span><span class=p>,</span><span class=w> </span><span class=n>code</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>MSG_TAG</span><span class=p>,</span><span class=w> </span><span class=n>msg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>RestResult</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>code</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>msg</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>CODE_TAG</span><span class=p>,</span><span class=w> </span><span class=n>code</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>MSG_TAG</span><span class=p>,</span><span class=w> </span><span class=n>msg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>data</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>super</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>DATA_TAG</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>RestResult</span><span class=w> </span><span class=nf>success</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RestResult</span><span class=p>(</span><span class=n>200</span><span class=p>,</span><span class=w> </span><span class=s>&#34;成功&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>然后准备 JWT 工具类，实现：生成 token、从 token 中获取用户名、检查 token 是否过期、刷新 token、验证 token 等，这里的 KEY 通过双重锁 保证了线程安全</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JwtTokenUtils</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Value</span><span class=p>(</span><span class=s>&#34;${token.secret}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>secret</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Value</span><span class=p>(</span><span class=s>&#34;${token.expireTime}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>expiration</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Value</span><span class=p>(</span><span class=s>&#34;${token.header}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>header</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Key</span><span class=w> </span><span class=n>KEY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 生成token令牌
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param userDetails 用户
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 令token牌
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>generateToken</span><span class=p>(</span><span class=n>UserDetails</span><span class=w> </span><span class=n>userDetails</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;[JwtTokenUtils] generateToken &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>userDetails</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>claims</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>claims</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;sub&#34;</span><span class=p>,</span><span class=w> </span><span class=n>userDetails</span><span class=p>.</span><span class=na>getUsername</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>claims</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;created&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>generateToken</span><span class=p>(</span><span class=n>claims</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 从令牌中获取用户名
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param token 令牌
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 用户名
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getUsernameFromToken</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Claims</span><span class=w> </span><span class=n>claims</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getClaimsFromToken</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>claims</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;sub&#34;</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;从令牌中获取用户名:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>username</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>username</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 判断令牌是否过期
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param token 令牌
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 是否过期
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Boolean</span><span class=w> </span><span class=nf>isTokenExpired</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Claims</span><span class=w> </span><span class=n>claims</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getClaimsFromToken</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Date</span><span class=w> </span><span class=n>expiration</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>claims</span><span class=p>.</span><span class=na>getExpiration</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>expiration</span><span class=p>.</span><span class=na>before</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 刷新令牌
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param token 原令牌
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 新令牌
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>refreshToken</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>refreshedToken</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Claims</span><span class=w> </span><span class=n>claims</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getClaimsFromToken</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>claims</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;created&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>refreshedToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>generateToken</span><span class=p>(</span><span class=n>claims</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>refreshedToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>refreshedToken</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 验证令牌
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param token 令牌
</span></span></span><span class=line><span class=cl><span class=cm>     * @param userDetails 用户
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 是否有效
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Boolean</span><span class=w> </span><span class=nf>validateToken</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=n>UserDetails</span><span class=w> </span><span class=n>userDetails</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getUsernameFromToken</span><span class=p>(</span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>username</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>userDetails</span><span class=p>.</span><span class=na>getUsername</span><span class=p>())</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>!</span><span class=n>isTokenExpired</span><span class=p>(</span><span class=n>token</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 从claims生成令牌
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param claims 数据声明
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 令牌
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>generateToken</span><span class=p>(</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>claims</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Date</span><span class=w> </span><span class=n>expirationDate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>expiration</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Jwts</span><span class=p>.</span><span class=na>builder</span><span class=p>().</span><span class=na>setClaims</span><span class=p>(</span><span class=n>claims</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setExpiration</span><span class=p>(</span><span class=n>expirationDate</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>signWith</span><span class=p>(</span><span class=n>SignatureAlgorithm</span><span class=p>.</span><span class=na>HS256</span><span class=p>,</span><span class=w> </span><span class=n>getKeyInstance</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>compact</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 从令牌中获取数据声明
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param token 令牌
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 数据声明
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Claims</span><span class=w> </span><span class=nf>getClaimsFromToken</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Claims</span><span class=w> </span><span class=n>claims</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>claims</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Jwts</span><span class=p>.</span><span class=na>parser</span><span class=p>().</span><span class=na>setSigningKey</span><span class=p>(</span><span class=n>getKeyInstance</span><span class=p>()).</span><span class=na>parseClaimsJws</span><span class=p>(</span><span class=n>token</span><span class=p>).</span><span class=na>getBody</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>claims</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>claims</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Key</span><span class=w> </span><span class=nf>getKeyInstance</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>KEY</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>JwtTokenUtils</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>KEY</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=c1>// 双重锁</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>apiKeySecretBytes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DatatypeConverter</span><span class=p>.</span><span class=na>parseBase64Binary</span><span class=p>(</span><span class=n>secret</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>KEY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SecretKeySpec</span><span class=p>(</span><span class=n>apiKeySecretBytes</span><span class=p>,</span><span class=w> </span><span class=n>SignatureAlgorithm</span><span class=p>.</span><span class=na>HS256</span><span class=p>.</span><span class=na>getJcaName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>KEY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>然后定义 JwtAuthTokenFilter，用于过滤请求</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JwtAuthTokenFilter</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>OncePerRequestFilter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>UserDetailsService</span><span class=w> </span><span class=n>userDetailsService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>JwtTokenUtils</span><span class=w> </span><span class=n>jwtTokenUtils</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doFilterInternal</span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w> </span><span class=n>FilterChain</span><span class=w> </span><span class=n>chain</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>ServletException</span><span class=p>,</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 从请求头中获取 Authorization 的值，即 token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>jwtToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=n>jwtTokenUtils</span><span class=p>.</span><span class=na>getHeader</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>ObjectUtils</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>jwtToken</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 从 token 中获取用户名，用户名存储在负载中，负载一般没有加密，所以负载的内容是可以见，不能在其中存放敏感信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 可以通过 https://jwt.io/ 进行解码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jwtTokenUtils</span><span class=p>.</span><span class=na>getUsernameFromToken</span><span class=p>(</span><span class=n>jwtToken</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>username</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>SecurityContextHolder</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>getAuthentication</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 通过 userDetailsService 从数据库中获取对应用户的信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>UserDetails</span><span class=w> </span><span class=n>userDetails</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>userDetailsService</span><span class=p>.</span><span class=na>loadUserByUsername</span><span class=p>(</span><span class=n>username</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 这里校验 token 有效性</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>jwtTokenUtils</span><span class=p>.</span><span class=na>validateToken</span><span class=p>(</span><span class=n>jwtToken</span><span class=p>,</span><span class=w> </span><span class=n>userDetails</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 将 UserDetails 对象 封装为 UsernamePasswordAuthenticationToken 对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 第一参数是 Object principal，传入的是 UserDetails 对象，在后面的 Service 中会取出 principal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>UsernamePasswordAuthenticationToken</span><span class=w> </span><span class=n>authenticationToken</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UsernamePasswordAuthenticationToken</span><span class=p>(</span><span class=n>userDetails</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>userDetails</span><span class=p>.</span><span class=na>getAuthorities</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 交给SpringSecurity管理，在之后的过滤器不会被拦截进行二次授权了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>SecurityContextHolder</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>setAuthentication</span><span class=p>(</span><span class=n>authenticationToken</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 将请求转发给过滤器链上的下一个对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>chain</span><span class=p>.</span><span class=na>doFilter</span><span class=p>(</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>编写 JwtAuthService，处理登录的相关逻辑，使用 AuthenticationManager 对传入的账号密码进行认证，成功返回 生成的 token</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JwtAuthService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>JwtTokenUtils</span><span class=w> </span><span class=n>jwtTokenUtils</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>AuthenticationManager</span><span class=w> </span><span class=n>authenticationManager</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>login</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Authentication</span><span class=w> </span><span class=n>authentication</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>authentication</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>authenticationManager</span><span class=p>.</span><span class=na>authenticate</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>UsernamePasswordAuthenticationToken</span><span class=p>(</span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>password</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;用户名或密码有误&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 这里就是获取的就是在前面 JwtAuthTokenFilter 中传入的 principal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>User</span><span class=w> </span><span class=n>loginUser</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>User</span><span class=p>)</span><span class=w> </span><span class=n>authentication</span><span class=p>.</span><span class=na>getPrincipal</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>jwtTokenUtils</span><span class=p>.</span><span class=na>generateToken</span><span class=p>(</span><span class=n>loginUser</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>用于登录的 Controller</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JwtLoginController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>JwtAuthService</span><span class=w> </span><span class=n>jwtAuthService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>({</span><span class=s>&#34;/login&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;/&#34;</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>RestResult</span><span class=w> </span><span class=nf>login</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RestResult</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RestResult</span><span class=p>.</span><span class=na>success</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jwtAuthService</span><span class=p>.</span><span class=na>login</span><span class=p>(</span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>password</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>result</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;token&#34;</span><span class=p>,</span><span class=w> </span><span class=n>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>在 SecurityConfig 中 注入并配置 Handler</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=c1>// 省略其他代码...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>JwtAuthTokenFilter</span><span class=w> </span><span class=n>jwtAuthTokenFilter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 重写 AuthenticationManager，避免报错</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>AuthenticationManager</span><span class=w> </span><span class=nf>authenticationManagerBean</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>authenticationManagerBean</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>configure</span><span class=p>(</span><span class=n>HttpSecurity</span><span class=w> </span><span class=n>http</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// http.formLogin()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//         .loginPage(&#34;/login.html&#34;)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//         .loginProcessingUrl(&#34;/login&#34;)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//         // .defaultSuccessUrl(&#34;/index&#34;)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//         // .defaultSuccessUrl(&#34;/index&#34;)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//         .successHandler(successHandler)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//         .failureHandler(failureHandler)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>http</span><span class=p>.</span><span class=na>sessionManagement</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 不创建和使用 session</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>sessionCreationPolicy</span><span class=p>(</span><span class=n>SessionCreationPolicy</span><span class=p>.</span><span class=na>STATELESS</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>and</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>authorizeRequests</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>antMatchers</span><span class=p>(</span><span class=s>&#34;/login&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>anonymous</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>antMatchers</span><span class=p>(</span><span class=n>HttpMethod</span><span class=p>.</span><span class=na>GET</span><span class=p>,</span><span class=w> </span><span class=s>&#34;/*.html&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;/**/*.html&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;/**/*.css&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;/**/*.js&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>permitAll</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 省略其他代码...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 使用 JWT 过滤器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>http</span><span class=p>.</span><span class=na>addFilterBefore</span><span class=p>(</span><span class=n>jwtAuthTokenFilter</span><span class=p>,</span><span class=w> </span><span class=n>UsernamePasswordAuthenticationFilter</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=c1>// 省略其他代码...</span><span class=w>
</span></span></span></code></pre></div><p>可以通过 Postman 先指定参数（注意是用 POST），获取 token：
<a href="http://localhost:8081/login?username=user&amp;password=1234">http://localhost:8081/login?username=user&amp;password=1234</a></p><p>在 Headers 中添加 <code>Authorization</code>，值为获取到的 token
使用 GET 访问：<a href=http://localhost:8081/order>http://localhost:8081/order</a>
因为 user 没有管理权限，所以访问管理页面会 403：<a href=http://localhost:8081/system/role>http://localhost:8081/system/role</a></p><p>具体代码参考 <a href=https://github.com/aaronlinv/springsecurity-jwt-demo/commit/a6c52f031e54f1cdc99244fcf9815b9dabdd0163>这里</a></p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://aaronlinv.github.io/posts/dockerfile-%E5%AE%9E%E8%B7%B5%E5%8F%8A%E6%A2%B3%E7%90%86/><span class=title>« Prev</span><br><span>Dockerfile 实践及梳理</span>
</a><a class=next href=https://aaronlinv.github.io/posts/docker-%E5%AE%9E%E8%B7%B5%E5%8F%8A%E5%91%BD%E4%BB%A4%E6%A2%B3%E7%90%86/><span class=title>Next »</span><br><span>Docker 实践及命令梳理</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://aaronlinv.github.io/>Aaron Lin</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>